<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Sample Flink Code That Reads From Kafka and Writes to Cassandra | Benjamin Guinebertière&#39;s blog (@benjguin)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="A few weeks ago, I wrote some code about Apache Flink that read from Apache Kafka, and writes to Cassandra.This post explains the context of the code, what it does and where you can find it. 
The cont">
<meta property="og:type" content="article">
<meta property="og:title" content="Sample Flink Code That Reads From Kafka and Writes to Cassandra">
<meta property="og:url" content="http://blog.3-4.fr/2016/12/12/Sample_Flink_Code/index.html">
<meta property="og:site_name" content="Benjamin Guinebertière's blog (@benjguin)">
<meta property="og:description" content="A few weeks ago, I wrote some code about Apache Flink that read from Apache Kafka, and writes to Cassandra.This post explains the context of the code, what it does and where you can find it. 
The cont">
<meta property="og:updated_time" content="2016-12-12T15:15:28.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Sample Flink Code That Reads From Kafka and Writes to Cassandra">
<meta name="twitter:description" content="A few weeks ago, I wrote some code about Apache Flink that read from Apache Kafka, and writes to Cassandra.This post explains the context of the code, what it does and where you can find it. 
The cont">
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  <script type='text/javascript' src='/js/tag.js'></script>
</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Benjamin Guinebertière&#39;s blog (@benjguin)</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        <a id="nav-search-btn" class="nav-icon" title="Rechercher"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://blog.3-4.fr"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-2016/12/12/Sample_Flink_Code" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/12/12/Sample_Flink_Code/" class="article-date">
  <time datetime="2016-12-11T23:00:00.000Z" itemprop="datePublished">2016-12-12</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Sample Flink Code That Reads From Kafka and Writes to Cassandra
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>A few weeks ago, I wrote some code about Apache Flink that read from Apache Kafka, and writes to Cassandra.<br>This post explains the context of the code, what it does and where you can find it. </p>
<h2 id="The-context"><a href="#The-context" class="headerlink" title="The context"></a>The context</h2><p>Last summer, I started an open source project called boontadata-streams.<br>It is an environment where one can compare big data streaming engines like Apache Flink, Apache Storm or Apache Spark Streaming to name a few.</p>
<p>You can find the project at <a href="https://github.com/boontadata/boontadata-streams/" target="_blank" rel="external">https://github.com/boontadata/boontadata-streams/</a>.</p>
<p>As of this writing, the project contains an implementation of with Flink. </p>
<p>The principle is to have the following components: </p>
<ul>
<li>Some Python code simulates IOT objects which<ul>
<li>send events to Kafka</li>
<li>send its view of the truth to an Apache Cassandra database</li>
</ul>
</li>
<li>Apache Flink consumes the events from Kafka. It calculates aggregates and writes them to the Cassandra database</li>
<li>Some other Python code reads the Cassandra database to compare the results between the IOT simulator and Flink</li>
</ul>
<p>For instance, here is what we get when time windows are calculated based on processing time:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">Comparing ingest device and flink for m1_sum</div><div class="line">--------------------------------------------------</div><div class="line">25 exceptions out of 25</div><div class="line"></div><div class="line">Exceptions are:</div><div class="line">            window_time                             device_id category  m1_sum_ingest_devicetime  m1_sum_flink  delta_m1_sum_ingestdevice_flink</div><div class="line">0   2016-12-05 14:51:55  90fddddf-c42c-4418-8133-fb3866fe826c    cat-1                     459.0           NaN                              NaN</div><div class="line">1   2016-12-05 14:52:00  90fddddf-c42c-4418-8133-fb3866fe826c    cat-1                     909.0         459.0                            450.0</div><div class="line">2   2016-12-05 14:52:05  90fddddf-c42c-4418-8133-fb3866fe826c    cat-1                     448.0         942.0                           -494.0</div><div class="line">3   2016-12-05 14:52:10  90fddddf-c42c-4418-8133-fb3866fe826c    cat-1                    1087.0         402.0                            685.0</div><div class="line">4   2016-12-05 14:52:15  90fddddf-c42c-4418-8133-fb3866fe826c    cat-1                     681.0        1203.0                           -522.0</div><div class="line">5   2016-12-05 14:52:20  90fddddf-c42c-4418-8133-fb3866fe826c    cat-1                       NaN         681.0                              NaN</div><div class="line">6   2016-12-05 14:51:55  90fddddf-c42c-4418-8133-fb3866fe826c    cat-2                     162.0           NaN                              NaN</div><div class="line">7   2016-12-05 14:52:00  90fddddf-c42c-4418-8133-fb3866fe826c    cat-2                     901.0         162.0                            739.0</div><div class="line">8   2016-12-05 14:52:05  90fddddf-c42c-4418-8133-fb3866fe826c    cat-2                     998.0         920.0                             78.0</div><div class="line">9   2016-12-05 14:52:10  90fddddf-c42c-4418-8133-fb3866fe826c    cat-2                     928.0        1033.0                           -105.0</div><div class="line">10  2016-12-05 14:52:15  90fddddf-c42c-4418-8133-fb3866fe826c    cat-2                     720.0         928.0                           -208.0</div><div class="line">11  2016-12-05 14:52:20  90fddddf-c42c-4418-8133-fb3866fe826c    cat-2                       NaN         768.0                              NaN</div><div class="line">12  2016-12-05 14:51:55  90fddddf-c42c-4418-8133-fb3866fe826c    cat-3                     325.0           NaN                              NaN</div><div class="line">13  2016-12-05 14:52:00  90fddddf-c42c-4418-8133-fb3866fe826c    cat-3                     857.0         227.0                            630.0</div><div class="line">14  2016-12-05 14:52:05  90fddddf-c42c-4418-8133-fb3866fe826c    cat-3                     767.0         939.0                           -172.0</div><div class="line">15  2016-12-05 14:52:10  90fddddf-c42c-4418-8133-fb3866fe826c    cat-3                     632.0         783.0                           -151.0</div><div class="line">16  2016-12-05 14:52:15  90fddddf-c42c-4418-8133-fb3866fe826c    cat-3                     415.0         632.0                           -217.0</div><div class="line">17  2016-12-05 14:52:20  90fddddf-c42c-4418-8133-fb3866fe826c    cat-3                       NaN         514.0                              NaN</div><div class="line">18  2016-12-05 14:49:50  90fddddf-c42c-4418-8133-fb3866fe826c    cat-4                      49.0           NaN                              NaN</div><div class="line">19  2016-12-05 14:51:55  90fddddf-c42c-4418-8133-fb3866fe826c    cat-4                     589.0           NaN                              NaN</div><div class="line">20  2016-12-05 14:52:00  90fddddf-c42c-4418-8133-fb3866fe826c    cat-4                    1078.0         589.0                            489.0</div><div class="line">21  2016-12-05 14:52:05  90fddddf-c42c-4418-8133-fb3866fe826c    cat-4                    1310.0        1156.0                            154.0</div><div class="line">22  2016-12-05 14:52:10  90fddddf-c42c-4418-8133-fb3866fe826c    cat-4                     905.0        1238.0                           -333.0</div><div class="line">23  2016-12-05 14:52:15  90fddddf-c42c-4418-8133-fb3866fe826c    cat-4                     693.0        1079.0                           -386.0</div><div class="line">24  2016-12-05 14:52:20  90fddddf-c42c-4418-8133-fb3866fe826c    cat-4                       NaN         820.0                              NaN</div></pre></td></tr></table></figure>
<p>and here is what we get when extracting time from the event data to get event time:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">Comparing ingest device and flink for m1_sum</div><div class="line">--------------------------------------------------</div><div class="line">5 exceptions out of 21</div><div class="line"></div><div class="line">Exceptions are:</div><div class="line">            window_time                             device_id category  m1_sum_ingest_devicetime  m1_sum_flink  delta_m1_sum_ingestdevice_flink</div><div class="line">4   2016-12-05 14:53:35  b8c0c5c4-9189-4a0d-a96b-55ca4adafe14    cat-1                       388           NaN                              NaN</div><div class="line">9   2016-12-05 14:53:35  b8c0c5c4-9189-4a0d-a96b-55ca4adafe14    cat-2                       496           NaN                              NaN</div><div class="line">14  2016-12-05 14:53:35  b8c0c5c4-9189-4a0d-a96b-55ca4adafe14    cat-3                       296           NaN                              NaN</div><div class="line">15  2016-12-05 14:51:10  b8c0c5c4-9189-4a0d-a96b-55ca4adafe14    cat-4                        49           NaN                              NaN</div><div class="line">20  2016-12-05 14:53:35  b8c0c5c4-9189-4a0d-a96b-55ca4adafe14    cat-4                       537           NaN                              NaN</div></pre></td></tr></table></figure>
<p>this second result is better. All the differences can be explained:<br>those with the <code>2016-12-05 14:53:35</code> time window happen because no further event was sent thta could trigger the calculation of this time Window;<br>the <code>2016-12-05 14:51:10</code> time window for cat4 corresponds to an event that was sent on purpose too late for the streaming engine to take it into account.</p>
<p>You can see the <a href="https://raw.githubusercontent.com/boontadata/boontadata-streams/master/doc/sample_execution_log.md" target="_blank" rel="external">full report in GitHub</a>. </p>
<p>Here are the versions used in the current implementation: </p>
<hr>
<table>
<thead>
<tr>
<th></th>
<th>Component</th>
<th>version</th>
<th>comments</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
<td>Python</td>
<td>Python 3.5.2</td>
<td>Anaconda 4.2.0 (64-bit)</td>
</tr>
<tr>
<td></td>
<td>Apache Kafka</td>
<td>0.10</td>
<td></td>
</tr>
<tr>
<td></td>
<td>Apache Flink</td>
<td>1.1.3</td>
<td></td>
</tr>
<tr>
<td></td>
<td>Apache Cassandra</td>
<td>3.9</td>
<td></td>
</tr>
<tr>
<td></td>
<td>Apache Zookeeper</td>
<td>3.4.9</td>
<td></td>
</tr>
</tbody>
</table>
<p>The project leverages Docker containers, it can run on a single Ubuntu VM with ~14 GB of RAM.<br>Of course, you are welcome to contribute. We may even let you use one of our Azure VMs while you develop. You can contact me: <code>contact à boontadata.io</code>. </p>
<h2 id="The-pom-and-the-code"><a href="#The-pom-and-the-code" class="headerlink" title="The pom and the code"></a>The pom and the code</h2><p>In order to write that, I relied on sample code on the Internet about Flink consuming Kafka and Flink writing to Cassandra. </p>
<p>What I consumed most of my time on was the Maven configuration file: <a href="https://github.com/boontadata/boontadata-streams/blob/master/code/flink/master/code/pom.xml" target="_blank" rel="external">pom.xml</a>.</p>
<p>I’m not a Java specialist, so I gave up on the JAR size optimization and preferred to have a <a href="http://stackoverflow.com/questions/11947037/what-is-an-uber-jar" target="_blank" rel="external">uber-jar</a>.</p>
<p>I couldn’t make the Kafka 0.10 client working so I used Kafka 0.8.2. This version of the client needs to communicate to Zookeeper. Still, it can read from Kafa 0.10.</p>
<p>In terms of <a href="https://github.com/boontadata/boontadata-streams/tree/master/code/flink/master/code/src/main/java/io/boontadata/flink1" target="_blank" rel="external">Flink code</a>, I created a pipeline that does the following: </p>
<ul>
<li>reads from Kafka</li>
<li>parses message</li>
<li>assigns timestamp and watermarks from event data</li>
<li>creates a time window in order to remove duplicates (the key is the <code>message id</code>)</li>
<li>creates a time window in order to aggregate (based on <code>device id</code>, <code>message category</code>)</li>
<li>sends some debugging information to Cassandra <code>debug</code> table about events and their time windows</li>
<li>aggredates data</li>
<li>writes results to Cassandra <code>agg_events</code> table</li>
</ul>
<p>Feel free to visit the <a href="https://github.com/boontadata/boontadata-streams" target="_blank" rel="external">GitHub repo</a>, use the code as samples, fix it and create a pull request when you find ways to improve it, add your own on Flink or other streaming engines.</p>
<p>:-) b</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.3-4.fr/2016/12/12/Sample_Flink_Code/" data-id="ciwm86a0k0000qocd5rrc4xch" class="article-share-link">Partager</a>
      
        <a href="http://blog.3-4.fr/2016/12/12/Sample_Flink_Code/#disqus_thread" class="article-comment-link">Commentaires</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Azure/">Azure</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/BigData/">BigData</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/IoT/">IoT</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
  
    <a href="/2016/09/05/IOT_Hub_Azure_Functions_Sigfox/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Ancien</strong>
      <div class="article-nav-title">Tutoriel - Synchronisation De Votre Application De Fonction Avec Le Concentrateur IoT Et Exemple De Connexion Avec Un Objet Sigfox</div>
    </a>
  
</nav>

  
</article>


<section id="comments">
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
</section>
</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Mot-clés</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Azure/">Azure</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Azure-Machine-Learning/">Azure Machine Learning</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/AzureFunctions/">AzureFunctions</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Big-Data/">Big Data</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/BigData/">BigData</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Data-Science/">Data Science</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Hadoop/">Hadoop</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/IoT/">IoT</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Sigfox/">Sigfox</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Spark/">Spark</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/docker/">docker</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Nuage de mot-clés</h3>
    <div class="widget tagcloud">
      <a href="/tags/Azure/" style="font-size: 20px;">Azure</a> <a href="/tags/Azure-Machine-Learning/" style="font-size: 10px;">Azure Machine Learning</a> <a href="/tags/AzureFunctions/" style="font-size: 10px;">AzureFunctions</a> <a href="/tags/Big-Data/" style="font-size: 16.67px;">Big Data</a> <a href="/tags/BigData/" style="font-size: 10px;">BigData</a> <a href="/tags/Data-Science/" style="font-size: 13.33px;">Data Science</a> <a href="/tags/Hadoop/" style="font-size: 13.33px;">Hadoop</a> <a href="/tags/IoT/" style="font-size: 13.33px;">IoT</a> <a href="/tags/Sigfox/" style="font-size: 10px;">Sigfox</a> <a href="/tags/Spark/" style="font-size: 10px;">Spark</a> <a href="/tags/docker/" style="font-size: 10px;">docker</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/12/">December 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/09/">September 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/08/">August 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/12/">December 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/11/">November 2015</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Articles récents</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2016/12/12/Sample_Flink_Code/">Sample Flink Code That Reads From Kafka and Writes to Cassandra</a>
          </li>
        
          <li>
            <a href="/2016/09/05/IOT_Hub_Azure_Functions_Sigfox/">Tutoriel - Synchronisation De Votre Application De Fonction Avec Le Concentrateur IoT Et Exemple De Connexion Avec Un Objet Sigfox</a>
          </li>
        
          <li>
            <a href="/2016/08/30/deploying_containers_to_one_or_several_VMs/">Deploying Containers to One or Several VMs</a>
          </li>
        
          <li>
            <a href="/2015/12/18/azure_ml_remove_label_from_web_service/">Azure ML, Remove Label From Web Service</a>
          </li>
        
          <li>
            <a href="/2015/12/02/mapr-on-azure/">MapR on Azure</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2016 Benjamin Guinebertière<br>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    
<script>
  var disqus_shortname = 'benjguin-blog34';
  
  var disqus_url = 'http://blog.3-4.fr/2016/12/12/Sample_Flink_Code/';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>