<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Benjamin Guinebertière&#39;s blog (@benjguin)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="Benjamin Guinebertière's blog (@benjguin)">
<meta property="og:url" content="http://blog.3-4.fr/index.html">
<meta property="og:site_name" content="Benjamin Guinebertière's blog (@benjguin)">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Benjamin Guinebertière's blog (@benjguin)">
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  <script type='text/javascript' src='/js/tag.js'></script>
</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Benjamin Guinebertière&#39;s blog (@benjguin)</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://blog.3-4.fr"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-2016/12/12/Sample_Flink_Code" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/12/12/Sample_Flink_Code/" class="article-date">
  <time datetime="2016-12-11T23:00:00.000Z" itemprop="datePublished">2016-12-12</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/12/12/Sample_Flink_Code/">Sample Flink Code That Reads From Kafka and Writes to Cassandra</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="The-context"><a href="#The-context" class="headerlink" title="The context"></a>The context</h2><p>Last summer, I started an open source project called <strong>boontadata-streams</strong>.<br>It is an environment where one can compare big data streaming engines like Apache Flink, Apache Storm or Apache Spark Streaming to name a few.</p>
<p>You can find the project at <a href="https://github.com/boontadata/boontadata-streams/" target="_blank" rel="external">https://github.com/boontadata/boontadata-streams/</a>.</p>
<p>As of this writing, the project contains an implementation of the scenario with Flink. </p>
<p>The principle is to have the following components: </p>
<ul>
<li>Some Python code simulates IOT objects which<ul>
<li>sends events to Kafka</li>
<li>sends its view of the truth to an Apache Cassandra database</li>
</ul>
</li>
<li>Apache Flink consumes the events from Kafka. It calculates aggregates and writes them to the Cassandra database</li>
<li>Some other Python code reads the Cassandra database to compare the results between the IOT simulator and Flink</li>
</ul>
<p>For instance, here is what we get when time windows are calculated based on <strong>processing time</strong>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">Comparing ingest device and flink for m1_sum</div><div class="line">--------------------------------------------------</div><div class="line">25 exceptions out of 25</div><div class="line"></div><div class="line">Exceptions are:</div><div class="line">            window_time                             device_id category  m1_sum_ingest_devicetime  m1_sum_flink  delta_m1_sum_ingestdevice_flink</div><div class="line">0   2016-12-05 14:51:55  90fddddf-c42c-4418-8133-fb3866fe826c    cat-1                     459.0           NaN                              NaN</div><div class="line">1   2016-12-05 14:52:00  90fddddf-c42c-4418-8133-fb3866fe826c    cat-1                     909.0         459.0                            450.0</div><div class="line">2   2016-12-05 14:52:05  90fddddf-c42c-4418-8133-fb3866fe826c    cat-1                     448.0         942.0                           -494.0</div><div class="line">3   2016-12-05 14:52:10  90fddddf-c42c-4418-8133-fb3866fe826c    cat-1                    1087.0         402.0                            685.0</div><div class="line">4   2016-12-05 14:52:15  90fddddf-c42c-4418-8133-fb3866fe826c    cat-1                     681.0        1203.0                           -522.0</div><div class="line">5   2016-12-05 14:52:20  90fddddf-c42c-4418-8133-fb3866fe826c    cat-1                       NaN         681.0                              NaN</div><div class="line">6   2016-12-05 14:51:55  90fddddf-c42c-4418-8133-fb3866fe826c    cat-2                     162.0           NaN                              NaN</div><div class="line">7   2016-12-05 14:52:00  90fddddf-c42c-4418-8133-fb3866fe826c    cat-2                     901.0         162.0                            739.0</div><div class="line">8   2016-12-05 14:52:05  90fddddf-c42c-4418-8133-fb3866fe826c    cat-2                     998.0         920.0                             78.0</div><div class="line">9   2016-12-05 14:52:10  90fddddf-c42c-4418-8133-fb3866fe826c    cat-2                     928.0        1033.0                           -105.0</div><div class="line">10  2016-12-05 14:52:15  90fddddf-c42c-4418-8133-fb3866fe826c    cat-2                     720.0         928.0                           -208.0</div><div class="line">11  2016-12-05 14:52:20  90fddddf-c42c-4418-8133-fb3866fe826c    cat-2                       NaN         768.0                              NaN</div><div class="line">12  2016-12-05 14:51:55  90fddddf-c42c-4418-8133-fb3866fe826c    cat-3                     325.0           NaN                              NaN</div><div class="line">13  2016-12-05 14:52:00  90fddddf-c42c-4418-8133-fb3866fe826c    cat-3                     857.0         227.0                            630.0</div><div class="line">14  2016-12-05 14:52:05  90fddddf-c42c-4418-8133-fb3866fe826c    cat-3                     767.0         939.0                           -172.0</div><div class="line">15  2016-12-05 14:52:10  90fddddf-c42c-4418-8133-fb3866fe826c    cat-3                     632.0         783.0                           -151.0</div><div class="line">16  2016-12-05 14:52:15  90fddddf-c42c-4418-8133-fb3866fe826c    cat-3                     415.0         632.0                           -217.0</div><div class="line">17  2016-12-05 14:52:20  90fddddf-c42c-4418-8133-fb3866fe826c    cat-3                       NaN         514.0                              NaN</div><div class="line">18  2016-12-05 14:49:50  90fddddf-c42c-4418-8133-fb3866fe826c    cat-4                      49.0           NaN                              NaN</div><div class="line">19  2016-12-05 14:51:55  90fddddf-c42c-4418-8133-fb3866fe826c    cat-4                     589.0           NaN                              NaN</div><div class="line">20  2016-12-05 14:52:00  90fddddf-c42c-4418-8133-fb3866fe826c    cat-4                    1078.0         589.0                            489.0</div><div class="line">21  2016-12-05 14:52:05  90fddddf-c42c-4418-8133-fb3866fe826c    cat-4                    1310.0        1156.0                            154.0</div><div class="line">22  2016-12-05 14:52:10  90fddddf-c42c-4418-8133-fb3866fe826c    cat-4                     905.0        1238.0                           -333.0</div><div class="line">23  2016-12-05 14:52:15  90fddddf-c42c-4418-8133-fb3866fe826c    cat-4                     693.0        1079.0                           -386.0</div><div class="line">24  2016-12-05 14:52:20  90fddddf-c42c-4418-8133-fb3866fe826c    cat-4                       NaN         820.0                              NaN</div></pre></td></tr></table></figure>
<p>and here is what we get when extracting time from the event data (<strong>event time</strong>):</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">Comparing ingest device and flink for m1_sum</div><div class="line">--------------------------------------------------</div><div class="line">5 exceptions out of 21</div><div class="line"></div><div class="line">Exceptions are:</div><div class="line">            window_time                             device_id category  m1_sum_ingest_devicetime  m1_sum_flink  delta_m1_sum_ingestdevice_flink</div><div class="line">4   2016-12-05 14:53:35  b8c0c5c4-9189-4a0d-a96b-55ca4adafe14    cat-1                       388           NaN                              NaN</div><div class="line">9   2016-12-05 14:53:35  b8c0c5c4-9189-4a0d-a96b-55ca4adafe14    cat-2                       496           NaN                              NaN</div><div class="line">14  2016-12-05 14:53:35  b8c0c5c4-9189-4a0d-a96b-55ca4adafe14    cat-3                       296           NaN                              NaN</div><div class="line">15  2016-12-05 14:51:10  b8c0c5c4-9189-4a0d-a96b-55ca4adafe14    cat-4                        49           NaN                              NaN</div><div class="line">20  2016-12-05 14:53:35  b8c0c5c4-9189-4a0d-a96b-55ca4adafe14    cat-4                       537           NaN                              NaN</div></pre></td></tr></table></figure>
<p>this second result is better. All the differences can be explained:<br>those with the <code>2016-12-05 14:53:35</code> time window happen because no further event was sent that could trigger the calculation of this time Window;<br>the <code>2016-12-05 14:51:10</code> time window for <code>cat4</code> corresponds to an event that was sent too late by the IOT simulator (on purpose) so that the streaming engine cannot take it into account.</p>
<p>You can see the <a href="https://github.com/boontadata/boontadata-streams/raw/7a09d63b5b73edb792f0821f8aa2408a770326d9/doc/sample_execution_log.md" target="_blank" rel="external">full execution log in GitHub</a>. </p>
<p>Here are the versions used in the current implementation: </p>
<hr>
<table>
<thead>
<tr>
<th></th>
<th>Component</th>
<th>version</th>
<th>comments</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
<td>Python</td>
<td>Python 3.5.2</td>
<td>Anaconda 4.2.0 (64-bit)</td>
</tr>
<tr>
<td></td>
<td>Apache Kafka</td>
<td>0.10</td>
<td></td>
</tr>
<tr>
<td></td>
<td>Apache Flink</td>
<td>1.1.3</td>
<td></td>
</tr>
<tr>
<td></td>
<td>Apache Cassandra</td>
<td>3.9</td>
<td></td>
</tr>
<tr>
<td></td>
<td>Apache Zookeeper</td>
<td>3.4.9</td>
<td></td>
</tr>
</tbody>
</table>
<p>The project leverages Docker containers, it can run on a single Ubuntu VM with ~14 GB of RAM.<br>Of course, you are welcome to contribute. We may even let you use one of our Azure VMs while you develop. You can contact me: <code>contact à boontadata.io</code>. </p>
<h2 id="The-pom-and-the-code"><a href="#The-pom-and-the-code" class="headerlink" title="The pom and the code"></a>The pom and the code</h2><p>In order to write that, I relied on sample code on the Internet about Flink consuming Kafka and Flink writing to Cassandra.<br>Still, it took me some time to put everything together. </p>
<p>What I consumed most of my time on was the Maven configuration file: <a href="https://github.com/boontadata/boontadata-streams/blob/master/code/flink/master/code/pom.xml" target="_blank" rel="external">pom.xml</a>.</p>
<p>I’m not a Java specialist, so I gave up on the JAR size optimization and preferred to have a <a href="http://stackoverflow.com/questions/11947037/what-is-an-uber-jar" target="_blank" rel="external">uber-jar</a>.</p>
<p>I couldn’t make the Kafka 0.10 client working so I used Kafka 0.8.2. This version of the client needs to communicate to Zookeeper. Still, it can read from Kafa 0.10.</p>
<p>In terms of <a href="https://github.com/boontadata/boontadata-streams/tree/master/code/flink/master/code/src/main/java/io/boontadata/flink1" target="_blank" rel="external">Flink code</a>, I created a pipeline that does the following: </p>
<ul>
<li>reads from Kafka</li>
<li>parses message</li>
<li>assigns timestamp and watermarks from event data</li>
<li>creates a time window in order to remove duplicates (the key is the <code>message id</code>)</li>
<li>creates a time window in order to aggregate (based on <code>device id</code>, <code>message category</code>)</li>
<li>sends some debugging information to Cassandra <code>debug</code> table about events and their time windows</li>
<li>aggredates data</li>
<li>writes results to Cassandra <code>agg_events</code> table</li>
</ul>
<p>Feel free to visit the <a href="https://github.com/boontadata/boontadata-streams" target="_blank" rel="external">GitHub repo</a>, or use the code as samples, or fix it and create a pull request when you find ways to improve it, or add your own implementation on other streaming engines like Storm, Spark streaming or others.</p>
<h2 id="A-copy-of-the-most-significant-pieces-of-code"><a href="#A-copy-of-the-most-significant-pieces-of-code" class="headerlink" title="A copy of the most significant pieces of code"></a>A copy of the most significant pieces of code</h2><p>The rest of this post is a copy of the most significant pieces of code</p>
<p>pom.xml:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div></pre></td><td class="code"><pre><div class="line">&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</div><div class="line">	xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;</div><div class="line">	&lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;</div><div class="line">	</div><div class="line">	&lt;groupId&gt;io.boontadata.flink1&lt;/groupId&gt;</div><div class="line">	&lt;artifactId&gt;flink1&lt;/artifactId&gt;</div><div class="line">	&lt;version&gt;0.1&lt;/version&gt;</div><div class="line">	&lt;packaging&gt;jar&lt;/packaging&gt;</div><div class="line"></div><div class="line">	&lt;name&gt;Flink flink1 Job&lt;/name&gt;</div><div class="line">	&lt;url&gt;http://boontadata.io&lt;/url&gt;</div><div class="line"></div><div class="line">	&lt;properties&gt;</div><div class="line">		&lt;project.build.sourceEncoding&gt;UTF-8&lt;/project.build.sourceEncoding&gt;</div><div class="line">		&lt;flink.version&gt;1.1.3&lt;/flink.version&gt;</div><div class="line">	&lt;/properties&gt;</div><div class="line"></div><div class="line">	&lt;repositories&gt;</div><div class="line">		&lt;repository&gt;</div><div class="line">			&lt;id&gt;apache.snapshots&lt;/id&gt;</div><div class="line">			&lt;name&gt;Apache Development Snapshot Repository&lt;/name&gt;</div><div class="line">			&lt;url&gt;https://repository.apache.org/content/repositories/snapshots/&lt;/url&gt;</div><div class="line">			&lt;releases&gt;</div><div class="line">				&lt;enabled&gt;false&lt;/enabled&gt;</div><div class="line">			&lt;/releases&gt;</div><div class="line">			&lt;snapshots&gt;</div><div class="line">				&lt;enabled&gt;true&lt;/enabled&gt;</div><div class="line">			&lt;/snapshots&gt;</div><div class="line">		&lt;/repository&gt;</div><div class="line">	&lt;/repositories&gt;</div><div class="line">	</div><div class="line">	&lt;dependencies&gt;</div><div class="line">		&lt;dependency&gt;</div><div class="line">			&lt;groupId&gt;org.apache.flink&lt;/groupId&gt;</div><div class="line">			&lt;artifactId&gt;flink-java&lt;/artifactId&gt;</div><div class="line">			&lt;version&gt;$&#123;flink.version&#125;&lt;/version&gt;</div><div class="line">			&lt;scope&gt;provided&lt;/scope&gt;</div><div class="line">		&lt;/dependency&gt;</div><div class="line">		&lt;dependency&gt;</div><div class="line">			&lt;groupId&gt;org.apache.flink&lt;/groupId&gt;</div><div class="line">			&lt;artifactId&gt;flink-clients_2.11&lt;/artifactId&gt;</div><div class="line">			&lt;version&gt;$&#123;flink.version&#125;&lt;/version&gt;</div><div class="line">			&lt;scope&gt;provided&lt;/scope&gt;</div><div class="line">		&lt;/dependency&gt;</div><div class="line">		&lt;dependency&gt;</div><div class="line">			&lt;groupId&gt;org.apache.flink&lt;/groupId&gt;</div><div class="line">			&lt;artifactId&gt;flink-streaming-java_2.11&lt;/artifactId&gt;</div><div class="line">			&lt;version&gt;$&#123;flink.version&#125;&lt;/version&gt;</div><div class="line">			&lt;scope&gt;provided&lt;/scope&gt;</div><div class="line">		&lt;/dependency&gt;</div><div class="line">		&lt;dependency&gt;</div><div class="line">			&lt;groupId&gt;org.apache.flink&lt;/groupId&gt;</div><div class="line">			&lt;artifactId&gt;flink-connector-kafka-0.8_2.11&lt;/artifactId&gt;</div><div class="line">			&lt;version&gt;$&#123;flink.version&#125;&lt;/version&gt;</div><div class="line">			&lt;scope&gt;provided&lt;/scope&gt;</div><div class="line">		&lt;/dependency&gt;</div><div class="line">		&lt;dependency&gt;</div><div class="line">			&lt;groupId&gt;org.apache.flink&lt;/groupId&gt;</div><div class="line">			&lt;artifactId&gt;flink-connector-cassandra_2.11&lt;/artifactId&gt;</div><div class="line">			&lt;version&gt;$&#123;flink.version&#125;&lt;/version&gt;</div><div class="line">			&lt;scope&gt;provided&lt;/scope&gt;</div><div class="line">		&lt;/dependency&gt;</div><div class="line">	&lt;/dependencies&gt;</div><div class="line"></div><div class="line">	&lt;build&gt;</div><div class="line">		&lt;plugins&gt;</div><div class="line">			&lt;plugin&gt;</div><div class="line">				&lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;</div><div class="line">				&lt;artifactId&gt;maven-dependency-plugin&lt;/artifactId&gt;</div><div class="line">				&lt;version&gt;2.9&lt;/version&gt;</div><div class="line">				&lt;executions&gt;</div><div class="line">					&lt;execution&gt;</div><div class="line">						&lt;id&gt;unpack&lt;/id&gt;</div><div class="line">						&lt;!-- executed just before the package phase --&gt;</div><div class="line">						&lt;phase&gt;prepare-package&lt;/phase&gt;</div><div class="line">						&lt;goals&gt;</div><div class="line">							&lt;goal&gt;unpack&lt;/goal&gt;</div><div class="line">						&lt;/goals&gt;</div><div class="line">						&lt;configuration&gt;</div><div class="line">							&lt;artifactItems&gt;</div><div class="line">								&lt;artifactItem&gt;</div><div class="line">									&lt;groupId&gt;org.apache.flink&lt;/groupId&gt;</div><div class="line">									&lt;artifactId&gt;flink-clients_2.11&lt;/artifactId&gt;</div><div class="line">									&lt;version&gt;$&#123;flink.version&#125;&lt;/version&gt;</div><div class="line">									&lt;type&gt;jar&lt;/type&gt;</div><div class="line">									&lt;overWrite&gt;true&lt;/overWrite&gt;</div><div class="line">									&lt;outputDirectory&gt;$&#123;project.build.directory&#125;/classes&lt;/outputDirectory&gt;</div><div class="line">									&lt;includes&gt;org/apache/flink/client/**&lt;/includes&gt;</div><div class="line">								&lt;/artifactItem&gt;</div><div class="line">								&lt;artifactItem&gt;</div><div class="line">									&lt;groupId&gt;org.apache.flink&lt;/groupId&gt;</div><div class="line">									&lt;artifactId&gt;flink-streaming-java_2.11&lt;/artifactId&gt;</div><div class="line">									&lt;version&gt;$&#123;flink.version&#125;&lt;/version&gt;</div><div class="line">									&lt;type&gt;jar&lt;/type&gt;</div><div class="line">									&lt;overWrite&gt;true&lt;/overWrite&gt;</div><div class="line">									&lt;outputDirectory&gt;$&#123;project.build.directory&#125;/classes&lt;/outputDirectory&gt;</div><div class="line">									&lt;includes&gt;org/apache/flink/streaming/**&lt;/includes&gt;</div><div class="line">								&lt;/artifactItem&gt;</div><div class="line">								&lt;artifactItem&gt;</div><div class="line">									&lt;groupId&gt;org.apache.flink&lt;/groupId&gt;</div><div class="line">									&lt;artifactId&gt;flink-connector-kafka-base_2.11&lt;/artifactId&gt;</div><div class="line">									&lt;version&gt;$&#123;flink.version&#125;&lt;/version&gt;</div><div class="line">									&lt;type&gt;jar&lt;/type&gt;</div><div class="line">									&lt;overWrite&gt;true&lt;/overWrite&gt;</div><div class="line">									&lt;outputDirectory&gt;$&#123;project.build.directory&#125;/classes&lt;/outputDirectory&gt;</div><div class="line">									&lt;includes&gt;org/apache/flink/streaming/**&lt;/includes&gt;</div><div class="line">								&lt;/artifactItem&gt;</div><div class="line">								&lt;artifactItem&gt;</div><div class="line">									&lt;groupId&gt;org.apache.flink&lt;/groupId&gt;</div><div class="line">									&lt;artifactId&gt;flink-connector-kafka-0.8_2.11&lt;/artifactId&gt;</div><div class="line">									&lt;version&gt;$&#123;flink.version&#125;&lt;/version&gt;</div><div class="line">									&lt;type&gt;jar&lt;/type&gt;</div><div class="line">									&lt;overWrite&gt;true&lt;/overWrite&gt;</div><div class="line">									&lt;outputDirectory&gt;$&#123;project.build.directory&#125;/classes&lt;/outputDirectory&gt;</div><div class="line">									&lt;includes&gt;org/apache/flink/streaming/connectors/kafka/**&lt;/includes&gt;</div><div class="line">								&lt;/artifactItem&gt;</div><div class="line">								&lt;artifactItem&gt;</div><div class="line">									&lt;groupId&gt;org.apache.flink&lt;/groupId&gt;</div><div class="line">									&lt;artifactId&gt;flink-streaming-java_2.11&lt;/artifactId&gt;</div><div class="line">									&lt;version&gt;$&#123;flink.version&#125;&lt;/version&gt;</div><div class="line">									&lt;type&gt;jar&lt;/type&gt;</div><div class="line">									&lt;overWrite&gt;true&lt;/overWrite&gt;</div><div class="line">									&lt;outputDirectory&gt;$&#123;project.build.directory&#125;/classes&lt;/outputDirectory&gt;</div><div class="line">									&lt;includes&gt;org/apache/flink/**&lt;/includes&gt;</div><div class="line">								&lt;/artifactItem&gt;</div><div class="line">								&lt;artifactItem&gt;</div><div class="line">									&lt;groupId&gt;org.apache.kafka&lt;/groupId&gt;</div><div class="line">									&lt;artifactId&gt;kafka_2.11&lt;/artifactId&gt;</div><div class="line">									&lt;version&gt;0.8.2.2&lt;/version&gt;</div><div class="line">									&lt;type&gt;jar&lt;/type&gt;</div><div class="line">									&lt;overWrite&gt;true&lt;/overWrite&gt;</div><div class="line">									&lt;outputDirectory&gt;$&#123;project.build.directory&#125;/classes&lt;/outputDirectory&gt;</div><div class="line">									&lt;includes&gt;kafka/**&lt;/includes&gt;</div><div class="line">								&lt;/artifactItem&gt;</div><div class="line">								&lt;artifactItem&gt;</div><div class="line">									&lt;groupId&gt;com.101tec&lt;/groupId&gt;</div><div class="line">									&lt;artifactId&gt;zkclient&lt;/artifactId&gt;</div><div class="line">									&lt;version&gt;0.8&lt;/version&gt;</div><div class="line">									&lt;type&gt;jar&lt;/type&gt;</div><div class="line">									&lt;overWrite&gt;true&lt;/overWrite&gt;</div><div class="line">									&lt;outputDirectory&gt;$&#123;project.build.directory&#125;/classes&lt;/outputDirectory&gt;</div><div class="line">									&lt;includes&gt;org/I0Itec/zkclient\/**&lt;/includes&gt;</div><div class="line">								&lt;/artifactItem&gt;</div><div class="line">								&lt;artifactItem&gt;</div><div class="line">									&lt;groupId&gt;org.apache.flink&lt;/groupId&gt;</div><div class="line">									&lt;artifactId&gt;flink-connector-cassandra_2.11&lt;/artifactId&gt;</div><div class="line">									&lt;version&gt;$&#123;flink.version&#125;&lt;/version&gt;</div><div class="line">									&lt;type&gt;jar&lt;/type&gt;</div><div class="line">									&lt;overWrite&gt;true&lt;/overWrite&gt;</div><div class="line">									&lt;outputDirectory&gt;$&#123;project.build.directory&#125;/classes&lt;/outputDirectory&gt;</div><div class="line">									&lt;includes&gt;org/apache/flink/**,com/datastax/driver/**&lt;/includes&gt;</div><div class="line">								&lt;/artifactItem&gt;</div><div class="line">								&lt;artifactItem&gt;</div><div class="line">									&lt;groupId&gt;com.yammer.metrics&lt;/groupId&gt;</div><div class="line">									&lt;artifactId&gt;metrics-core&lt;/artifactId&gt;</div><div class="line">									&lt;version&gt;2.2.0&lt;/version&gt;</div><div class="line">									&lt;type&gt;jar&lt;/type&gt;</div><div class="line">									&lt;overWrite&gt;true&lt;/overWrite&gt;</div><div class="line">									&lt;outputDirectory&gt;$&#123;project.build.directory&#125;/classes&lt;/outputDirectory&gt;</div><div class="line">									&lt;includes&gt;com/yammer/metrics/**&lt;/includes&gt;</div><div class="line">								&lt;/artifactItem&gt;</div><div class="line">								&lt;artifactItem&gt;</div><div class="line">									&lt;groupId&gt;org.apache.servicemix.bundles&lt;/groupId&gt;</div><div class="line">									&lt;artifactId&gt;org.apache.servicemix.bundles.kafka-clients&lt;/artifactId&gt;</div><div class="line">									&lt;version&gt;0.8.2.2_1&lt;/version&gt;</div><div class="line">									&lt;type&gt;jar&lt;/type&gt;</div><div class="line">									&lt;overWrite&gt;true&lt;/overWrite&gt;</div><div class="line">									&lt;outputDirectory&gt;$&#123;project.build.directory&#125;/classes&lt;/outputDirectory&gt;</div><div class="line">									&lt;includes&gt;org/apache/kafka/**&lt;/includes&gt;</div><div class="line">								&lt;/artifactItem&gt;</div><div class="line">							&lt;/artifactItems&gt;</div><div class="line">						&lt;/configuration&gt;</div><div class="line">					&lt;/execution&gt;</div><div class="line">				&lt;/executions&gt;</div><div class="line">			&lt;/plugin&gt;					</div><div class="line">			&lt;plugin&gt;</div><div class="line">				&lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;</div><div class="line">				&lt;artifactId&gt;maven-compiler-plugin&lt;/artifactId&gt;</div><div class="line">				&lt;version&gt;3.1&lt;/version&gt;</div><div class="line">				&lt;configuration&gt;</div><div class="line">					&lt;source&gt;1.8&lt;/source&gt; &lt;!-- If you want to use Java 8, change this to &quot;1.8&quot; --&gt;</div><div class="line">					&lt;target&gt;1.8&lt;/target&gt; &lt;!-- If you want to use Java 8, change this to &quot;1.8&quot; --&gt;</div><div class="line">				&lt;/configuration&gt;</div><div class="line">			&lt;/plugin&gt;</div><div class="line">		&lt;/plugins&gt;</div><div class="line"></div><div class="line">		&lt;!-- If you want to use Java 8 Lambda Expressions uncomment the following lines --&gt;</div><div class="line">		&lt;pluginManagement&gt;</div><div class="line">			&lt;plugins&gt;</div><div class="line">				&lt;plugin&gt;</div><div class="line">					&lt;artifactId&gt;maven-compiler-plugin&lt;/artifactId&gt;</div><div class="line">					&lt;configuration&gt;</div><div class="line">						&lt;source&gt;1.8&lt;/source&gt;</div><div class="line">						&lt;target&gt;1.8&lt;/target&gt;</div><div class="line">						&lt;compilerId&gt;jdt&lt;/compilerId&gt;</div><div class="line">					&lt;/configuration&gt;</div><div class="line">					&lt;dependencies&gt;</div><div class="line">						&lt;dependency&gt;</div><div class="line">							&lt;groupId&gt;org.eclipse.tycho&lt;/groupId&gt;</div><div class="line">							&lt;artifactId&gt;tycho-compiler-jdt&lt;/artifactId&gt;</div><div class="line">							&lt;version&gt;0.21.0&lt;/version&gt;</div><div class="line">						&lt;/dependency&gt;</div><div class="line">					&lt;/dependencies&gt;</div><div class="line">				&lt;/plugin&gt;</div><div class="line">				&lt;plugin&gt;</div><div class="line">					&lt;groupId&gt;org.eclipse.m2e&lt;/groupId&gt;</div><div class="line">					&lt;artifactId&gt;lifecycle-mapping&lt;/artifactId&gt;</div><div class="line">					&lt;version&gt;1.0.0&lt;/version&gt;</div><div class="line">					&lt;configuration&gt;</div><div class="line">						&lt;lifecycleMappingMetadata&gt;</div><div class="line">							&lt;pluginExecutions&gt;</div><div class="line">								&lt;pluginExecution&gt;</div><div class="line">									&lt;pluginExecutionFilter&gt;</div><div class="line">										&lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;</div><div class="line">										&lt;artifactId&gt;maven-assembly-plugin&lt;/artifactId&gt;</div><div class="line">										&lt;versionRange&gt;[2.4,)&lt;/versionRange&gt;</div><div class="line">										&lt;goals&gt;</div><div class="line">											&lt;goal&gt;single&lt;/goal&gt;</div><div class="line">										&lt;/goals&gt;</div><div class="line">									&lt;/pluginExecutionFilter&gt;</div><div class="line">									&lt;action&gt;</div><div class="line">										&lt;ignore/&gt;</div><div class="line">									&lt;/action&gt;</div><div class="line">								&lt;/pluginExecution&gt;</div><div class="line">								&lt;pluginExecution&gt;</div><div class="line">									&lt;pluginExecutionFilter&gt;</div><div class="line">										&lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;</div><div class="line">										&lt;artifactId&gt;maven-compiler-plugin&lt;/artifactId&gt;</div><div class="line">										&lt;versionRange&gt;[3.1,)&lt;/versionRange&gt;</div><div class="line">										&lt;goals&gt;</div><div class="line">											&lt;goal&gt;testCompile&lt;/goal&gt;</div><div class="line">											&lt;goal&gt;compile&lt;/goal&gt;</div><div class="line">										&lt;/goals&gt;</div><div class="line">									&lt;/pluginExecutionFilter&gt;</div><div class="line">									&lt;action&gt;</div><div class="line">										&lt;ignore/&gt;</div><div class="line">									&lt;/action&gt;</div><div class="line">								&lt;/pluginExecution&gt;</div><div class="line">							&lt;/pluginExecutions&gt;</div><div class="line">						&lt;/lifecycleMappingMetadata&gt;</div><div class="line">					&lt;/configuration&gt;</div><div class="line">				&lt;/plugin&gt;</div><div class="line">			&lt;/plugins&gt;</div><div class="line">		&lt;/pluginManagement&gt;</div><div class="line">	&lt;/build&gt;</div><div class="line"></div><div class="line"></div><div class="line">&lt;/project&gt;</div></pre></td></tr></table></figure></p>
<p>StreamingJob.java:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div></pre></td><td class="code"><pre><div class="line">package io.boontadata.flink1;</div><div class="line"></div><div class="line">import com.datastax.driver.core.Cluster;</div><div class="line">import java.lang.Double;</div><div class="line">import java.lang.Long;</div><div class="line">import java.text.Format;</div><div class="line">import java.text.SimpleDateFormat;</div><div class="line">import java.time.Instant;</div><div class="line">import java.util.Date;</div><div class="line">import java.util.Iterator;</div><div class="line">import java.util.Properties;</div><div class="line">import org.apache.flink.streaming.api.environment.StreamExecutionEnvironment;</div><div class="line"></div><div class="line">import org.apache.flink.api.common.functions.MapFunction;</div><div class="line">import org.apache.flink.api.common.functions.ReduceFunction;</div><div class="line">import org.apache.flink.api.java.functions.KeySelector;</div><div class="line">import org.apache.flink.api.java.tuple.Tuple;</div><div class="line">import org.apache.flink.api.java.tuple.Tuple2;</div><div class="line">import org.apache.flink.api.java.tuple.Tuple5;</div><div class="line">import org.apache.flink.api.java.tuple.Tuple6;</div><div class="line">import org.apache.flink.streaming.api.datastream.DataStream;</div><div class="line">import org.apache.flink.streaming.api.datastream.WindowedStream;</div><div class="line">import org.apache.flink.streaming.api.environment.StreamExecutionEnvironment;</div><div class="line">import org.apache.flink.streaming.api.functions.sink.SinkFunction;</div><div class="line">import org.apache.flink.streaming.api.functions.source.RichParallelSourceFunction;</div><div class="line">import org.apache.flink.streaming.api.functions.windowing.WindowFunction;</div><div class="line">import org.apache.flink.streaming.api.TimeCharacteristic;</div><div class="line">import org.apache.flink.streaming.api.windowing.time.Time;</div><div class="line">import org.apache.flink.streaming.api.windowing.windows.Window;</div><div class="line">import org.apache.flink.streaming.api.windowing.windows.TimeWindow;</div><div class="line">import org.apache.flink.streaming.connectors.cassandra.CassandraTupleSink;</div><div class="line">import org.apache.flink.streaming.connectors.cassandra.ClusterBuilder;</div><div class="line">import org.apache.flink.streaming.connectors.kafka.FlinkKafkaConsumer082;</div><div class="line">import org.apache.flink.util.Collector;</div><div class="line">import org.apache.flink.streaming.util.serialization.SimpleStringSchema;</div><div class="line"></div><div class="line">import static java.util.concurrent.TimeUnit.MILLISECONDS;</div><div class="line"></div><div class="line">/**</div><div class="line"> * Skeleton for a Flink Streaming Job.</div><div class="line"> *</div><div class="line"> * For a full example of a Flink Streaming Job, see the SocketTextStreamWordCount.java</div><div class="line"> * file in the same package/directory or have a look at the website.</div><div class="line"> *</div><div class="line"> * You can also generate a .jar file that you can submit on your Flink</div><div class="line"> * cluster.</div><div class="line"> * Just type</div><div class="line"> * 		mvn clean package</div><div class="line"> * in the projects root directory.</div><div class="line"> * You will find the jar in</div><div class="line"> * 		target/quickstart-0.1.jar</div><div class="line"> * From the CLI you can then run</div><div class="line"> * 		./bin/flink run -c io.boontadata.flink1.StreamingJob target/quickstart-0.1.jar</div><div class="line"> *</div><div class="line"> * For more information on the CLI see:</div><div class="line"> *</div><div class="line"> * http://flink.apache.org/docs/latest/apis/cli.html</div><div class="line"> */</div><div class="line">public class StreamingJob &#123;</div><div class="line">	private static final String VERSION = &quot;161205a&quot;;</div><div class="line"></div><div class="line">	private static final Integer FIELD_MESSAGE_ID = 0;</div><div class="line">	private static final Integer FIELD_DEVICE_ID = 1;</div><div class="line">	private static final Integer FIELD_TIMESTAMP = 2;</div><div class="line">	private static final Integer FIELD_CATEGORY = 3;</div><div class="line">	private static final Integer FIELD_MEASURE1 = 4;</div><div class="line">	private static final Integer FIELD_MESAURE2 = 5; </div><div class="line"></div><div class="line">	public static void main(String[] args) throws Exception &#123;</div><div class="line">		String timeCharacteristic = &quot;EventTime&quot;;</div><div class="line">		if (args.length &gt; 0) &#123;</div><div class="line">			timeCharacteristic = args[0];</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		// set up the streaming execution environment</div><div class="line">		final StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();</div><div class="line">		env.enableCheckpointing(5000); // checkpoint every 5000 msecs</div><div class="line">		env.setParallelism(2);</div><div class="line">		</div><div class="line">		if (timeCharacteristic.equals(&quot;EventTime&quot;)) &#123;</div><div class="line">			env.setStreamTimeCharacteristic(TimeCharacteristic.EventTime);</div><div class="line">		&#125; else if (timeCharacteristic.equals(&quot;ProcessingTime&quot;)) &#123;</div><div class="line">			env.setStreamTimeCharacteristic(TimeCharacteristic.ProcessingTime);</div><div class="line">		&#125; else if (timeCharacteristic.equals(&quot;IngestionTime&quot;)) &#123;</div><div class="line">			env.setStreamTimeCharacteristic(TimeCharacteristic.IngestionTime);</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		Format windowTimeFormat = new SimpleDateFormat(&quot;yyyy-MM-dd HH:mm:ss&quot;);</div><div class="line"></div><div class="line">		// properties about Kafka</div><div class="line">		Properties kProperties = new Properties();</div><div class="line">		kProperties.setProperty(&quot;bootstrap.servers&quot;, &quot;ks1:9092,ks2:9092,ks3:9092&quot;);</div><div class="line">		kProperties.setProperty(&quot;zookeeper.connect&quot;, &quot;zk1:2181&quot;);</div><div class="line">		kProperties.setProperty(&quot;group.id&quot;, &quot;flinkGroup&quot;);</div><div class="line"></div><div class="line"></div><div class="line">		// get data from Kafka, parse, and assign time and watermarks</div><div class="line">		DataStream&lt;Tuple6&lt;String, String, Long, String, Long, Double&gt;&gt; stream_parsed_with_timestamps = env </div><div class="line">			.addSource(new FlinkKafkaConsumer082&lt;&gt;(</div><div class="line">                                &quot;sampletopic&quot;,</div><div class="line">                                new SimpleStringSchema(),</div><div class="line">                                kProperties))</div><div class="line">			.rebalance()</div><div class="line">			.map(</div><div class="line">				new MapFunction&lt;String, </div><div class="line">					Tuple6&lt;String, String, Long, String, Long, Double&gt;&gt;() &#123;</div><div class="line">					private static final long serialVersionUID = 34_2016_10_19_001L;</div><div class="line"></div><div class="line">					@Override</div><div class="line">					public Tuple6&lt;String, String, Long, String, Long, Double&gt; map(String value) throws Exception &#123;</div><div class="line">						String[] splits = value.split(&quot;\\|&quot;);</div><div class="line">						return new Tuple6&lt;String, String, Long, String, Long, Double&gt;(</div><div class="line">							splits[FIELD_MESSAGE_ID], </div><div class="line">							splits[FIELD_DEVICE_ID],</div><div class="line">							Long.parseLong(splits[FIELD_TIMESTAMP]),</div><div class="line">							splits[FIELD_CATEGORY],</div><div class="line">							Long.parseLong(splits[FIELD_MEASURE1]),</div><div class="line">							Double.parseDouble(splits[FIELD_MESAURE2])</div><div class="line">						);</div><div class="line">					&#125;</div><div class="line">				&#125;</div><div class="line">			)</div><div class="line">			.assignTimestampsAndWatermarks(new BoundedOutOfOrdernessGenerator());</div><div class="line"></div><div class="line">		// deduplicate on message ID</div><div class="line">		WindowedStream stream_windowed_for_deduplication = stream_parsed_with_timestamps</div><div class="line">			.keyBy(FIELD_MESSAGE_ID)</div><div class="line">			.timeWindow(Time.of(5000, MILLISECONDS), Time.of(5000, MILLISECONDS));</div><div class="line"></div><div class="line">		DataStream&lt;Tuple6&lt;String,String,Long,String,Long,Double&gt;&gt; stream_deduplicated = stream_windowed_for_deduplication			</div><div class="line">			.apply(new WindowFunction&lt;Tuple6&lt;String, String, Long, String, Long, Double&gt;, </div><div class="line">				Tuple6&lt;String, String, Long, String, Long, Double&gt;, Tuple, TimeWindow&gt;() &#123;</div><div class="line">				// remove duplicates. cf http://stackoverflow.com/questions/35599069/apache-flink-0-10-how-to-get-the-first-occurence-of-a-composite-key-from-an-unbo</div><div class="line">				</div><div class="line">				@Override</div><div class="line">				public void apply(Tuple tuple, TimeWindow window, Iterable&lt;Tuple6&lt;String, String, Long, String, Long, Double&gt;&gt; input, </div><div class="line">					Collector&lt;Tuple6&lt;String, String, Long, String, Long, Double&gt;&gt; out) throws Exception &#123;</div><div class="line">					out.collect(input.iterator().next());</div><div class="line">				&#125;</div><div class="line">			&#125;);</div><div class="line"></div><div class="line">		// Group by device ID, Category</div><div class="line">		WindowedStream stream_windowed_for_groupby = stream_deduplicated</div><div class="line">			.keyBy(FIELD_DEVICE_ID, FIELD_CATEGORY)</div><div class="line">			.timeWindow(Time.of(5000, MILLISECONDS), Time.of(5000, MILLISECONDS));</div><div class="line"></div><div class="line">		// add debug information on stream_windowed_for_groupby</div><div class="line">		stream_windowed_for_groupby</div><div class="line">			.apply(new WindowFunction&lt;Tuple6&lt;String, String, Long, String, Long, Double&gt;, </div><div class="line">				Tuple2&lt;String, String&gt;, Tuple, TimeWindow&gt;() &#123;</div><div class="line"></div><div class="line">				@Override</div><div class="line">				public void apply(Tuple keyTuple, TimeWindow window, Iterable&lt;Tuple6&lt;String, String, Long, String, Long, Double&gt;&gt; input, </div><div class="line">					Collector&lt;Tuple2&lt;String, String&gt;&gt; out) throws Exception &#123;</div><div class="line"></div><div class="line">					for(Iterator&lt;Tuple6&lt;String, String, Long, String, Long, Double&gt;&gt; i=input.iterator(); i.hasNext();) &#123;</div><div class="line">                                                Tuple6&lt;String, String, Long, String, Long, Double&gt; value = i.next();</div><div class="line"></div><div class="line">						out.collect(new Tuple2&lt;String, String&gt;(</div><div class="line">							&quot;v&quot; + VERSION + &quot;- stream_windowed_for_groupby - &quot; + Instant.now().toString(), </div><div class="line">							&quot;MESSAGE_ID=&quot; + value.getField(0).toString() + &quot;, &quot;</div><div class="line">							+ &quot;DEVICE_ID=&quot; + value.getField(1).toString() + &quot;, &quot;</div><div class="line">							+ &quot;TIMESTAMP=&quot; + value.getField(2).toString() + &quot;, &quot;</div><div class="line">							+ &quot;time window start=&quot; + (new Long(window.getStart()).toString()) + &quot;, &quot;</div><div class="line">							+ &quot;time window end=&quot; + (new Long(window.getEnd()).toString()) + &quot;, &quot;</div><div class="line">							+ &quot;CATEGORY=&quot; + value.getField(3).toString() + &quot;, &quot;</div><div class="line">							+ &quot;M1=&quot; + value.getField(4).toString() + &quot;, &quot;</div><div class="line">							+ &quot;M2=&quot; + value.getField(5).toString()</div><div class="line">						));</div><div class="line">					&#125;</div><div class="line">				&#125;</div><div class="line">			&#125;)</div><div class="line">			.addSink(new CassandraTupleSink&lt;Tuple2&lt;String, String&gt;&gt;(</div><div class="line">                                &quot;INSERT INTO boontadata.debug&quot;</div><div class="line">                                        + &quot; (id, message)&quot;</div><div class="line">                                        + &quot; VALUES (?, ?);&quot;,</div><div class="line">                                new ClusterBuilder() &#123;</div><div class="line">                                        @Override</div><div class="line">                                        public Cluster buildCluster(Cluster.Builder builder) &#123;</div><div class="line">                                                return builder</div><div class="line">                                                        .addContactPoint(&quot;cassandra1&quot;).withPort(9042)</div><div class="line">                                                        .addContactPoint(&quot;cassandra2&quot;).withPort(9042)</div><div class="line">                                                        .addContactPoint(&quot;cassandra3&quot;).withPort(9042)</div><div class="line">                                                        .build();</div><div class="line">                                        &#125;</div><div class="line">                                &#125;));</div><div class="line"></div><div class="line"></div><div class="line">		// calculate sums for M1 and M2</div><div class="line">		DataStream&lt;Tuple5&lt;String, String, String, Long, Double&gt;&gt; stream_with_aggregations = stream_windowed_for_groupby</div><div class="line">			.apply(new WindowFunction&lt;Tuple6&lt;String, String, Long, String, Long, Double&gt;, </div><div class="line">				Tuple5&lt;String, String, String, Long, Double&gt;, Tuple, TimeWindow&gt;() &#123;</div><div class="line">			        // sum measures 1 and 2</div><div class="line"></div><div class="line">				@Override</div><div class="line">				public void apply(Tuple keyTuple, TimeWindow window, Iterable&lt;Tuple6&lt;String, String, Long, String, Long, Double&gt;&gt; input, </div><div class="line">					Collector&lt;Tuple5&lt;String, String, String, Long, Double&gt;&gt; out) throws Exception &#123;</div><div class="line"></div><div class="line">					long window_timestamp_milliseconds = window.getEnd();</div><div class="line">					String device_id=keyTuple.getField(0); // DEVICE_ID</div><div class="line">					String category=keyTuple.getField(1); // CATEGORY</div><div class="line">					long sum_of_m1=0L;</div><div class="line">					Double sum_of_m2=0.0d;</div><div class="line"></div><div class="line">					for(Iterator&lt;Tuple6&lt;String, String, Long, String, Long, Double&gt;&gt; i=input.iterator(); i.hasNext();) &#123;</div><div class="line">                                                Tuple6&lt;String, String, Long, String, Long, Double&gt; item = i.next();</div><div class="line">						sum_of_m1 += item.f4; // FIELD_MEASURE1</div><div class="line">						sum_of_m2 += item.f5; // FIELD_MESAURE2</div><div class="line">					&#125;</div><div class="line"></div><div class="line">					out.collect(new Tuple5&lt;String, String, String, Long, Double&gt;(</div><div class="line">								windowTimeFormat.format(new Date(window_timestamp_milliseconds)),</div><div class="line">								device_id, </div><div class="line">								category,</div><div class="line">								sum_of_m1,</div><div class="line">								sum_of_m2</div><div class="line">							));</div><div class="line">				&#125;</div><div class="line">			&#125;);</div><div class="line"></div><div class="line">		// send aggregations to destination</div><div class="line">		stream_with_aggregations</div><div class="line">			.addSink(new CassandraTupleSink&lt;Tuple5&lt;String, String, String, Long, Double&gt;&gt;(</div><div class="line">                                &quot;INSERT INTO boontadata.agg_events&quot;</div><div class="line">                                        + &quot; (window_time, device_id, category, m1_sum_flink, m2_sum_flink)&quot;</div><div class="line">                                        + &quot; VALUES (?, ?, ?, ?, ?);&quot;,</div><div class="line">                                new ClusterBuilder() &#123;</div><div class="line">                                        @Override</div><div class="line">                                        public Cluster buildCluster(Cluster.Builder builder) &#123;</div><div class="line">                                                return builder</div><div class="line">                                                        .addContactPoint(&quot;cassandra1&quot;).withPort(9042)</div><div class="line">                                                        .addContactPoint(&quot;cassandra2&quot;).withPort(9042)</div><div class="line">                                                        .addContactPoint(&quot;cassandra3&quot;).withPort(9042)</div><div class="line">                                                        .build();</div><div class="line">                                        &#125;</div><div class="line">                                &#125;));</div><div class="line"></div><div class="line">		// execute program</div><div class="line">		env.execute(&quot;io.boontadata.flink1.StreamingJob v&quot; + VERSION + &quot; (&quot; + timeCharacteristic + &quot;)&quot;);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>BoundedOutOfOrdernessGenerator.java:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line">package io.boontadata.flink1;</div><div class="line"></div><div class="line">import org.apache.flink.streaming.api.environment.StreamExecutionEnvironment;</div><div class="line"></div><div class="line">import org.apache.flink.api.common.functions.ReduceFunction;</div><div class="line">import org.apache.flink.api.java.functions.KeySelector;</div><div class="line">import org.apache.flink.api.java.tuple.Tuple;</div><div class="line">import org.apache.flink.api.java.tuple.Tuple5;</div><div class="line">import org.apache.flink.api.java.tuple.Tuple6;</div><div class="line">import org.apache.flink.streaming.api.datastream.DataStream;</div><div class="line">import org.apache.flink.streaming.api.environment.StreamExecutionEnvironment;</div><div class="line">import org.apache.flink.streaming.api.functions.AssignerWithPeriodicWatermarks;</div><div class="line">import org.apache.flink.streaming.api.functions.sink.SinkFunction;</div><div class="line">import org.apache.flink.streaming.api.functions.source.RichParallelSourceFunction;</div><div class="line">import org.apache.flink.streaming.api.functions.windowing.WindowFunction;</div><div class="line">import org.apache.flink.streaming.api.windowing.time.Time;</div><div class="line">import org.apache.flink.streaming.api.windowing.windows.Window;</div><div class="line">import org.apache.flink.util.Collector;</div><div class="line">import org.apache.flink.streaming.api.watermark.Watermark;</div><div class="line"></div><div class="line">import static java.util.concurrent.TimeUnit.MILLISECONDS;</div><div class="line"></div><div class="line">// cf https://ci.apache.org/projects/flink/flink-docs-release-1.1/apis/streaming/event_timestamps_watermarks.html</div><div class="line">/**</div><div class="line"> * This generator generates watermarks assuming that elements come out of order to a certain degree only.</div><div class="line"> * The latest elements for a certain timestamp t will arrive at most n milliseconds after the earliest</div><div class="line"> * elements for timestamp t.</div><div class="line"> */</div><div class="line">public class BoundedOutOfOrdernessGenerator implements AssignerWithPeriodicWatermarks&lt;Tuple6&lt;String, String, Long, String, Long, Double&gt;&gt; &#123;</div><div class="line">    private final long maxOutOfOrderness = 1_000L; // 1 second</div><div class="line">    private long currentMaxTimestamp = 0;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public long extractTimestamp(Tuple6&lt;String, String, Long, String, Long, Double&gt; element, long previousElementTimestamp) &#123;</div><div class="line">        long timestamp = element.f2; // get processing timestamp from current event</div><div class="line">        currentMaxTimestamp = Math.max(timestamp, currentMaxTimestamp);</div><div class="line">        return timestamp;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public Watermark getCurrentWatermark() &#123;</div><div class="line">        // return the watermark as current highest timestamp minus the out-of-orderness bound</div><div class="line">        return new Watermark(currentMaxTimestamp - maxOutOfOrderness);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>:-) b</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.3-4.fr/2016/12/12/Sample_Flink_Code/" data-id="ciwm86a0k0000qocd5rrc4xch" class="article-share-link">Share</a>
      
        <a href="http://blog.3-4.fr/2016/12/12/Sample_Flink_Code/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Azure/">Azure</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/BigData/">BigData</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/IoT/">IoT</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-2016/09/05/IOT_Hub_Azure_Functions_Sigfox" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/09/05/IOT_Hub_Azure_Functions_Sigfox/" class="article-date">
  <time datetime="2016-09-04T22:00:00.000Z" itemprop="datePublished">2016-09-05</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/09/05/IOT_Hub_Azure_Functions_Sigfox/">Tutoriel - Synchronisation De Votre Application De Fonction Avec Le Concentrateur IoT Et Exemple De Connexion Avec Un Objet Sigfox</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Ce tutoriel a été rédigé par Eugénie Vinet, stagiaire à la Direction Technique de Microsoft France de avril à août 2016 avec l’aide de son maître de stage Philippe Beraud, Chief Security Advisor à la Direction Technique.<br>Je remercie Eugénie et Philippe pour cette contribution.</p>
<h2 id="Synchroniser-une-application-de-fonction-avec-un-concentrateur-IoT"><a href="#Synchroniser-une-application-de-fonction-avec-un-concentrateur-IoT" class="headerlink" title="Synchroniser une application de fonction avec un concentrateur IoT"></a>Synchroniser une application de fonction avec un concentrateur IoT</h2><p>Pour créer une application de fonction avec Azure Function App, procédez comme suit :</p>
<p>1/    Connectez-vous au portail d’Azure à l’adresse <a href="https://portal.azure.com" target="_blank" rel="external">https://portal.azure.com</a>  </p>
<p>2/    Cliquez sur <strong>New</strong> en haut à gauche et cherchez Function App. </p>
<p><img src="/images/160905a/img1.png" alt=""></p>
<p>3/     Cliquez sur <strong>create</strong>. Entrez ensuite un nom, lié le à un de vos groupes de ressources existants (ou à défaut créez-en un nouveau). Si vous voulez que votre application de fonction fonctionne en continu, choisissez un plan de service B1 associé au minimum.<br>Le portail <strong>Function App</strong> s’affiche</p>
<p><img src="/images/160905a/img2.png" alt=""></p>
<p>4/    Cliquez sur <strong>Or create your own custom function en bas. </strong>Une liste des modèles disponibles s’affiche pour votre application de fonction.<br><img src="/images/160905a/img3.png" alt=""></p>
<p>5/    Selon votre choix de programmation (C# ou Node) cliquez sur <strong>EventHubTrigger – C#</strong> ou <strong>EventHubTrigger – Node</strong>.<br>Azure Function App propose de déclencher une fonction à partir d’un événement dans un concentrateur d’événements, mais pas dans un concentrateur IOT; cependant, un concentrateur IOT peut être vu comme un concentrateur d’événements. C’est ce que nous allons faire. </p>
<p>6/    Précisez le nom de votre application de fonction et configurez la connexion avec votre concentrateur IoT dans <strong>Event Hub connection</strong>.<br><img src="/images/160905a/img4.png" alt=""></p>
<p>Pour connaître le nom et la chaîne de connexion du concentrateur IoT :</p>
<p>a.    Rendez-vous dans les paramètres de votre concentrateur IoT puis cliquez sur <strong>Messaging</strong>. </p>
<p>b.    Notez la valeur de <strong>Event-Hub compatible name</strong> (par exemple DecodeSigfoxHub dans notre illustration) ainsi que celle de Compatible endpoint.<br><img src="/images/160905a/img5.png" alt=""></p>
<p>c.    Toujours au niveau de votre concentrateur IoT, allez ensuite dans <strong>Shared Access Policies</strong> et copier la <strong>connection string – primary Key</strong>. Enlevez la partie HostName à la chaine de caractères de manière à ne garder que SharedAccessKeyName et SharedAccessKey.  Vous obtenez par exemple :<br><code>SharedAccessKeyName=iothubowner;SharedAccessKey=MrsSPDzU5=8g2gZZPKXOJ9EJ5RDlo2PVzmPuGniLRwQ=</code></p>
<p>d.    Retournez dans la fenêtre de votre application de fonction - ne fermez pas la fenêtre de paramètres de votre concentrateur IoT, vous en aurez besoin plus tard -. Nommez votre application de fonction comme bon vous semble :)</p>
<p>e.    Dans <strong>Event Hub Name</strong>, entrez la valeur précédente de Event-Hub compatible name. Attention cependant, il ne supporte que les noms en minuscule. S’il y a des majuscules dans votre valeur de Event hub compatible name, passez tout en minuscule (par exemple decodesigfoxhub dans notre illustration)  </p>
<p>f.    Cliquez ensuite sur <strong>select</strong> à côté de Event Hub connection. Cliquez ensuite sur<strong> Add a connection</strong> string en haut à droite.<br><img src="/images/160905a/img6.png" alt=""></p>
<p>g.    Dans <strong>Connection name</strong>, spécifiez le nom que vous souhaitez. </p>
<p>h.    Dans <strong>Connection string</strong>, précisez :<br><code>Endpoint=&lt;CompatibleEndpoint&gt;&lt;SharedAccessKeyName&gt;&lt;SharedAccessKey&gt;</code><br>Vous obtenez une chaine de caractère semblable à :<br><code>Endpoint=sb://iothub-ns-decodesigf-499548662a53f6c.servicebus.windows.net/;SharedAccessKeyName=iothubowner;SharedAccessKey=MrsSPDzU5=8g2gZZPKXOJ9EJ5RDlo2PVzmPuGniLRwQ=</code></p>
<p>7/    Validez.<br>Votre application de fonction s’exécutera alors à chaque message reçu par l’utilisateur.<br>Vous pouvez alors modifier les informations que vous recevez de votre concentrateur IoT pour les renvoyer autre part ou les stocker par exemple.<br>Vous trouverez ci-après un exemple concret d’usage d’une application de fonction dans notre contexte, à savoir le décodage de trames Sigfox pour les renvoyer sur la solution préconfigurée de surveillance à distance (Cf. portail associé à l’adresse <a href="https://www.azureiotsuite.com/" target="_blank" rel="external">https://www.azureiotsuite.com/</a>) . </p>
<h2 id="Exemple-avec-IoT-Suie-Objet-Sigfox"><a href="#Exemple-avec-IoT-Suie-Objet-Sigfox" class="headerlink" title="Exemple avec IoT Suie - Objet Sigfox"></a>Exemple avec IoT Suie - Objet Sigfox</h2><p>Nous vous proposons dans cette section un exemple de projet utilisant Azure Function App avec un concentrateur IoT.<br>La solution préconfigurée de surveillance à distance s’attend recevoir des messages sur son concentrateur IoT de type :<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">	DeviceId = XX,</div><div class="line">	Humidity = XX,</div><div class="line">	Temperature = XX,</div><div class="line">	ExternalTemperature = XX</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>Dans ce projet nous voulons utiliser des objets Sigfox (voir ici <a href="http://makers.sigfox.com/#about" target="_blank" rel="external">http://makers.sigfox.com/#about</a>) qui envoient des trames de type :<br>« 422D17 » avec 42 l’identifiant du type d’objet, 2D l’humidité (45%) et 17 la température (en décimal = 23°C). »<br>On va supposer que l’humidité et la température sont deux entiers qui vont de 0 à 100. </p>
<h3 id="Prerequis"><a href="#Prerequis" class="headerlink" title="Prérequis"></a>Prérequis</h3><p>Les prérequis sont les suivants :<br>•    Avoir lié un device Sigfox qui envoie des données de température et d’humidité, Cf. tutoriel <a href="http://danvy.tv/push-your-sigfox-devices-data-to-azure-iot-hub/" target="_blank" rel="external">PUSH YOUR SIGFOX DEVICES DATA TO AZURE IOT HUB</a> .</p>
<p>•    Avoir créé et provisionné une solution préconfigurée de type Solution de surveillance à distance sur le site dédié à l’adresse <a href="http://www.azureiotsuite.com/" target="_blank" rel="external">http://www.azureiotsuite.com/</a>.</p>
<p>•    Avoir suivi l’étape précédente de synchronisation d’une Function App avec un <strong>concentrateur IoT en utilisant le concentrateur IoT Hub lié à l’objet Sigfox</strong>. </p>
<p>Si ces prérequis sont satisfaits, les étapes de mise en œuvre sont les suivantes :</p>
<p>•    Etape 1 – Ajout de l’objet préconfiguré.</p>
<p>•    Etape 2 – Remplissage du fichier JSON.</p>
<p>•    Etape 3 – Ajout des paquets.</p>
<p>•    Etape 4 – Contenu de votre application de fonction.</p>
<p>Nous les développons dans l’ordre au travers d’une section dédiée propre.</p>
<h3 id="Etape-1-–-Ajout-de-l’objet-preconfigure"><a href="#Etape-1-–-Ajout-de-l’objet-preconfigure" class="headerlink" title="Etape 1 – Ajout de l’objet préconfiguré"></a>Etape 1 – Ajout de l’objet préconfiguré</h3><p>Pour ajouter un objet, procédez comme suit :</p>
<ol>
<li>Rendez-vous à présent sur l’environnement de démonstration iotmsfrance à l’adresse <a href="https://www.azureiotsuite.com/" target="_blank" rel="external">https://www.azureiotsuite.com/</a>. </li>
<li>Connectez-vous avec votre compte. Comme cela a été indiqué précédemment, vous devez disposer de privilèges d’administration pour pouvoir enregistrer un objet.<br>De plus, réalisez cette étape UNIQUEMENT si l’objet n’apparait pas dans la liste des appareils du concentrateur IoT de l’environnement de démonstration (vous pouvez vérifié via le portail Azure ou via l’application <strong>Device Explorer</strong>). Si votre objet est déjà présent dans la liste, il faudra le supprimer en utilisant le <strong>Device Explorer</strong>.<br>L’application <strong>Device Explorer</strong> est téléchargeable à l’adresse <a href="https://github.com/Azure/azure-iot-sdks/releases" target="_blank" rel="external">https://github.com/Azure/azure-iot-sdks/releases</a>. Le répertoire d’installation par défaut de cette application est :<br>C:\Program Files (x86)\Microsoft\DeviceExplorer</li>
<li>Une fois sur le site, dans la liste des solutions approvisionnées, sélectionnez la <strong>Solution de surveillance à distance</strong>, c.à.d. la solution <votresolution>.azurewebsite.net.</votresolution></li>
<li>Cliquez en bas à gauche sur <strong>Ajouter un appareil</strong> (ou Add a device en anglais).<br><img src="/images/160905a/img7.png" alt=""><br>L’étape 1 d’ajout d’un appareil s’affiche.<br><img src="/images/160905a/img8.png" alt=""></li>
<li>Dans le cadre <strong>Appareil personnalisé</strong>, sélectionnez <strong>Ajouter un nouveau</strong>. L’étape 2 s’affiche.<br><img src="/images/160905a/img9.png" alt=""></li>
<li>Sélectionnez l’option <strong>Me laisser définir mon propre ID d’appareil</strong> et donnez lui le même ID que dans Sigfox /!\ ça ne marchera pas si vous choisissez un id différent.  </li>
<li>Cliquez sur <strong>Vérifier l’ID</strong>. L’ID doit être disponible. </li>
<li>Cliquez enfin sur <strong>Créer</strong>.<br>A ce stade, l’objet n’est pas activé dans la plateforme. Il va falloir modifier les informations relatives à l’objet dans la base NoSQL DocumentDB. Pour cela, connectez-vous au portail d’Azure à l’adresse <a href="https://portal.azure.com" target="_blank" rel="external">https://portal.azure.com</a>  et réalisez l’étape suivante.  </li>
</ol>
<h2 id="Etape-2-–-Remplissage-du-fichier-JSON"><a href="#Etape-2-–-Remplissage-du-fichier-JSON" class="headerlink" title="Etape 2 – Remplissage du fichier JSON"></a>Etape 2 – Remplissage du fichier JSON</h2><p>Pour remplir le fichier JSON d’informations lié à l’objet, procédez comme suit :</p>
<ol>
<li>Rendez-vous dans la rubrique DocumentDB Accounts sur le portail Azure à l’adresse <a href="https://portal.azure.com" target="_blank" rel="external">https://portal.azure.com</a>.  <img src="/images/160905a/img10.png" alt=""></li>
<li>Sélectionner le compte DocumentDB du projet :<br><img src="/images/160905a/img11.png" alt=""></li>
<li>Cliquez ensuite sur votre base de données DevMgmtDb (1). Dans <strong>DevMgmtDB</strong>, cliquez sur <strong>Document Explorer</strong> (2).  <img src="/images/160905a/img12.png" alt=""><br>Vous devriez voir apparaitre une liste comme celle-ci : </li>
</ol>
<pre><code>{
    &quot;DeviceProperties&quot;: {
    &quot;DeviceID&quot;: &quot;{NomDeVotreDevice}&quot;,
    &quot;HubEnabledState&quot;: true,
    &quot;CreatedTime&quot;: &quot;0001-01-01T00:00:00&quot;,
    &quot;DeviceState&quot;: &quot;normal&quot;,
    &quot;Manufacturer&quot;: &quot;{Manufacturer}&quot;,
    &quot;ModelNumber&quot;: &quot;{NomDuModelDuDevice}&quot;,
    &quot;SerialNumber&quot;: &quot;{NumeroDeSérie}&quot;,
    &quot;FirmwareVersion&quot;: &quot;{FirmwareVersion}&quot;,
    &quot;Platform&quot;: &quot;{Plateform}&quot;,
    &quot;Latitude&quot;: {Longitude} ,
    &quot;Longitude&quot;: {Latitude},
    &quot;Processor&quot;: &quot;{processor}&quot;,
    &quot;InstalledRAM&quot;: &quot;{installedRam}&quot;,
},
&quot;SystemProperties&quot;: {
    &quot;ICCID&quot;: null
},
 &quot;Commands&quot;: [
    {
      &quot;Name&quot;: &quot;PingDevice&quot;,
      &quot;Parameters&quot;: null
    },
    {
      &quot;Name&quot;: &quot;StartTelemetry&quot;,
      &quot;Parameters&quot;: null
    },
{
  &quot;Name&quot;: &quot;StopTelemetry&quot;,
  &quot;Parameters&quot;: null
},
{
  &quot;Name&quot;: &quot;ChangeSetPointTemp&quot;,
  &quot;Parameters&quot;: [
    {
      &quot;Name&quot;: &quot;SetPointTemp&quot;,
      &quot;Type&quot;: &quot;double&quot;
    }
  ]
},
{
  &quot;Name&quot;: &quot;DiagnosticTelemetry&quot;,
  &quot;Parameters&quot;: [
    {
      &quot;Name&quot;: &quot;Active&quot;,
      &quot;Type&quot;: &quot;boolean&quot;
    }
  ]
},
{
  &quot;Name&quot;: &quot;ChangeDeviceState&quot;,
  &quot;Parameters&quot;: [
    {
      &quot;Name&quot;: &quot;DeviceState&quot;,
      &quot;Type&quot;: &quot;string&quot;
    }
  ]
}
],
&quot;CommandHistory&quot;: [],
&quot;IsSimulatedDevice&quot;: 0,
 &quot;id&quot;: &quot;&quot;,
 &quot;Telemetry&quot;: [
    {
  &quot;Name&quot;: &quot;Temperature&quot;,
  &quot;DisplayName&quot;: &quot;Temperature&quot;,
  &quot;Type&quot;: &quot;double&quot;
},
{
  &quot;Name&quot;: &quot;Humidity&quot;,
  &quot;DisplayName&quot;: &quot;Humidity&quot;,
  &quot;Type&quot;: &quot;double&quot;
}
],
 &quot;Version&quot;: &quot;1.0&quot;,
 &quot;ObjectType&quot;: &quot;DeviceInfo&quot;
 }
}
</code></pre><p>Si vous n’avez pas réalisé l’étape 3 si l’objet existait déjà dans le concentrateur IoT, il est possible qu’il n’y ait aucun fichier relatif à l’objet dans la base de données. Il va alors falloir en créer un en cliquant en haut à gauche.<br>Par contre si vous aviez réalisé l’étape 3, le fichier relatif au device devrait se trouver dans la liste. Il devrait avoir un nom de type « 2f23278e-0e82-4850-86f5-b5c3f83a8850 » ou bien le nom du device comme « BFFBA ».  Pour vérifier si un fichier est lié à votre objet, il suffit de l’ouvrir et de lire le DeviceID. Il doit être identique à l’ID que vous avez enregistré sur la page web de la solution de surveillance à distance et identique à l’ID de l’objet enregistré sur le portail Sigfox. (1)<br>Supprimez ou modifiez le contenu du fichier dont le DeviceID est le nom de votre objet et recopier le texte à droite puis complétez/modifiez les zones en jaune comme suit :</p>
<pre><code>    HubEnabledState : doit être passé à true.
    DeviceState : doit être normal. 
    CreatedTime : doit être de la forme : AAAA-MM-JJThh:mm:ss 
Avec AAAA l’année, MM le mois, JJ le jour, hh l’heure, mm les minutes et ss les secondes. 
Il est recommandé de mettre la date et l’heure qu’il est au moment où vous remplissez le fichier mais cela ne va pas avoir d’impact sur le fonctionnement général de la surveillance à distance. 
    SerialNumber : doit préciser le numéro de série de l’objet si celui en est « équipé ». A défaut, écrivez le nom de l’objet entre guillemets.
    Manufacturer : doit préciser le nom du fabricant de l’objet entre guillemets.
    ModelNumber : doit préciser le numéro de modèle de l’objet si celui en est « équipé ». A défaut, écrivez le nom de l’objet entre guillemets
    FirmwareVersion, Platform, Processor et InstalledRam : si vous ne les connaissez pas pour le device utilisé vous pouvez écrire « None ». 
    Latitude et Longitude : vous avez le choix de son emplacement. L’objet s’affichera à l’endroit indiqué sur la carte. Vous pouvez vous aider de ce site : http://www.latlong.net/ pour trouver la longitude et la latitude d’un endroit précis. Attention : la longitude et la latitude ne doivent pas être écrites entre guillemets sur le document. 
    Id : sera l’ID du document que vous avez créé/modifié. Il est recommandé d’utiliser le nom de l’objet afin de retrouver plus facilement le document. 
</code></pre><h2 id="Etape-3-Ajout-des-paquets"><a href="#Etape-3-Ajout-des-paquets" class="headerlink" title="Etape 3 - Ajout des paquets"></a>Etape 3 - Ajout des paquets</h2><p>Tout d’abord nous allons ajouter les paquets nécessaires à notre application de fonction. Pour ceci, nous allons suivre les étapes pour charger un fichier project.json contenant le nom de tous nos paquets (rubrique Package Management sur le site <a href="https://azure.microsoft.com/en-us/documentation/articles/functions-reference-csharp/" target="_blank" rel="external">https://azure.microsoft.com/en-us/documentation/articles/functions-reference-csharp/</a> et File Update ici <a href="https://azure.microsoft.com/en-us/documentation/articles/functions-reference/#fileupdate" target="_blank" rel="external">https://azure.microsoft.com/en-us/documentation/articles/functions-reference/#fileupdate</a> ).<br>Procédez comme suit :</p>
<ol>
<li>Rendez-vous dans les outils de votre application de fonction.<br><img src="/images/160905a/img13.png" alt=""></li>
<li>Cliquez sur Kudu puis sur accédez. Vous vous retrouvez donc sur le système de gestion des fichiers de votre application de fonction. </li>
<li>Allez dans Debug Console puis PowerShell. En utilisant la commande ou bien en utilisant l’explorateur de fichier au-dessus rendez-vous sur D:\home\site\wwwroot\<nomdevotreapplicationdefonction>&gt;</nomdevotreapplicationdefonction></li>
<li><p>Ajoutez alors un fichier project.json qui contient les lignes suivantes - un simple glissé-déposé suffit - :  </p>
<p>  {<br>  “frameworks”: {<br>  “net46”:{</p>
<pre><code>&quot;dependencies&quot;: {                                                
        &quot;Microsoft.Azure.Devices.Client&quot;:&quot;1.0.6&quot;,
        &quot;Newtonsoft.Json&quot;:&quot;8.0.3&quot;,                
        &quot;Microsoft.Azure.Devices&quot;:&quot;1.0.6&quot;            
        }
    }      
}
</code></pre><p>  }</p>
</li>
</ol>
<h2 id="Etape-4-–-Definition-du-contenu-de-votre-application-de-fonction"><a href="#Etape-4-–-Definition-du-contenu-de-votre-application-de-fonction" class="headerlink" title="Etape 4 – Définition du contenu de votre application de fonction"></a>Etape 4 – Définition du contenu de votre application de fonction</h2><p>Pour définir le contenu de votre application de fonction, procédez comme suit :</p>
<p>1/    Retournez sur votre application de fonction et ajoutez la classe <strong>DataToReceive</strong>. Le contenu dépendra du contenu du JSON entré pour le callback de votre Device Type dans le portail Sigfox.<br>Si vous avez par exemple ce JSON : </p>
<pre><code>{
   &quot;device&quot; : &quot;{device}&quot;,
   &quot;data&quot; : &quot;{data}&quot;,
   &quot;time&quot; : {time},
   &quot;snr&quot; : {snr},
   &quot;station&quot; : &quot;{station}&quot;,
   &quot;rssi&quot; : {rssi},
   &quot;seqNumber&quot; : {seqNumber}
}
</code></pre><p>Votre classe <strong>DataToReceive</strong> doit ressembler à cela : </p>
<pre><code>public class DataToReceive
{
    public string device { get; set; }
    public string data { get; set; }
    public double time { get; set; }
    public string seqNumber { get; set; }
    public string rssi { get; set; }
    public string snr { get; set; }
    public string station { get; set; }
}
</code></pre><p>Il faut qu’il y ait au minimum les variables « device » et « data ». </p>
<p>2/    Créer ensuite une classe <strong>DataToSend</strong> qui réunira les informations que vous voulez envoyer dans votre solution préconfigurée de surveillance à distance. Nous envoyons ici que l’Id de l’objet, la température et l’humidité. Vous pouvez ajouter le paramètre <strong>External Température</strong>. </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">public class DataToSend</div><div class="line">&#123;</div><div class="line">    public string DeviceId &#123; get; set; &#125;</div><div class="line">    public double Humidity &#123; get; set; &#125;</div><div class="line">    public double Temperature &#123; get; set; &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>3/    Créez la classe <strong>SendToIotHub</strong> comme suit. Remplacez bien les valeurs de <strong>connectionString</strong> et d’<strong>iotHubUri</strong> par les éléments relatifs au concentrateur IoT de la solution préconfigurée.  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line">public class SendToIotHub</div><div class="line">&#123;</div><div class="line">    DeviceClient deviceClient;</div><div class="line">    Device device;</div><div class="line">    string jsonMessageToSend;</div><div class="line">    string connectionString = &quot;&#123;IotHubConnexionString&#125;&quot;;</div><div class="line">    string iotHubUri = &quot;&#123;IotHubName&#125;.azure-devices.net&quot;;</div><div class="line"></div><div class="line">    public async void sendData(DataToSend data, TraceWriter log)</div><div class="line">    &#123;</div><div class="line">        RegistryManager registryManager = RegistryManager.CreateFromConnectionString(connectionString);</div><div class="line">        device = new Device(data.DeviceId);</div><div class="line">        device = await AddDeviceAsync1(data.DeviceId, registryManager);</div><div class="line">        deviceClient = DeviceClient.Create(iotHubUri, new DeviceAuthenticationWithRegistrySymmetricKey(data.DeviceId,device.Authentication.SymmetricKey.PrimaryKey.ToString()));</div><div class="line">       jsonMessageToSend = JsonConvert.SerializeObject(data);</div><div class="line">        var messageToSend = new Microsoft.Azure.Devices.Client.Message(System.Text.Encoding.ASCII.GetBytes(jsonMessageToSend));</div><div class="line"></div><div class="line">        deviceClient.SendEventAsync(messageToSend);</div><div class="line">        log.Info($&quot;C# Event Hub trigger function processed a message: &#123;jsonMessageToSend&#125;&quot;);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">        private async Task&lt;Device&gt; AddDeviceAsync1(string deviceId, RegistryManager registryManager)</div><div class="line">        &#123;</div><div class="line">            Device device;</div><div class="line">            try</div><div class="line">            &#123;</div><div class="line">                device = await registryManager.AddDeviceAsync(new Device(deviceId));</div><div class="line">    </div><div class="line">            &#125;</div><div class="line">            catch (DeviceAlreadyExistsException)</div><div class="line">            &#123;</div><div class="line">                device = await registryManager.GetDeviceAsync(deviceId);</div><div class="line">            &#125;</div><div class="line">            return device;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>4/    Ajoutez les directives using « de circonstance » au début de votre application de fonction :</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">using Microsoft.Azure.Devices;</div><div class="line">using Microsoft.Azure.Devices.Client;</div><div class="line">using System;</div><div class="line">using Microsoft.Azure.Devices.Common.Exceptions;</div><div class="line">using Newtonsoft.Json;</div></pre></td></tr></table></figure>
<p>5/    Complétez maintenant la méthode <strong>Run</strong> : </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">public static void Run(string myEventHubMessage, TraceWriter log)</div><div class="line">&#123;</div><div class="line">    log.Info($&quot;C# Event Hub trigger function processed a message: &#123;myEventHubMessage&#125;&quot;);</div><div class="line"></div><div class="line">    DataToReceive receivedData = new DataToReceive();</div><div class="line">    DataToSend sentData = new DataToSend();</div><div class="line">    SendToIotHub sendDataToIotHub = new SendToIotHub();</div><div class="line">    receivedData = JsonConvert.DeserializeObject&lt;DataToReceive&gt;(myEventHubMessage);</div><div class="line"></div><div class="line">    if (receivedData.data != null &amp;&amp; receivedData.data.Substring(0, 2) == &quot;42&quot;)</div><div class="line">    &#123;</div><div class="line">            string data = receivedData.data;</div><div class="line">            sentData.Humidity = Convert.ToInt32(data.Substring(2, 2), 16);</div><div class="line">            sentData.Temperature = Convert.ToInt32(data.Substring(4, 2), 16);</div><div class="line">            sentData.DeviceId = receivedData.device;</div><div class="line">            sendDataToIotHub.sendData(sentData, log);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Vous obtiendrez quelque chose de similaire à la capture qui suit si tout va bien :</p>
<p><img src="/images/160905a/img14.png" alt=""></p>
<p>Vous devriez voir dans les logs les messages reçus et envoyés si vous gardez les lignes de code <code>log.info (…..)</code>. </p>
<p>Bien sûr, nous partons du principe que les trames à utiliser sont de la forme <strong>« 422D17 »</strong> (comme développé précédemment) mais il est possible que vous ayez à faire des calculs sur chaque élément de votre trame pour obtenir les valeurs décimales renvoyées par vos capteurs. Pour ceci, renseignez-vous auprès du constructeur de l’objet.  </p>
<p>Et voilà !<br>Ceci conclut ce tutoriel.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.3-4.fr/2016/09/05/IOT_Hub_Azure_Functions_Sigfox/" data-id="cispuveyn0000nscdr86d7mej" class="article-share-link">Share</a>
      
        <a href="http://blog.3-4.fr/2016/09/05/IOT_Hub_Azure_Functions_Sigfox/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Azure/">Azure</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/AzureFunctions/">AzureFunctions</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/IoT/">IoT</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Sigfox/">Sigfox</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-2016/08/30/deploying_containers_to_one_or_several_VMs" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/08/30/deploying_containers_to_one_or_several_VMs/" class="article-date">
  <time datetime="2016-08-30T22:00:00.000Z" itemprop="datePublished">2016-08-31</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/08/30/deploying_containers_to_one_or_several_VMs/">Deploying Containers to One or Several VMs</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Here is a sample test to show how Docker Swarm and Docker Compose simplify network management. </p>
<p>We’ll deploy a topology of 3 containers and see how they can reach each other. In the first case, we deploy it on a single node. In the second case, we deploy it on a 2 host swarm cluster.</p>
<p>The Swarm cluster is created as a Swarm Azure Container Service instance with the main following parameters: </p>
<ul>
<li>Orchestrator configuration: Swarm (btw, other option for ACS is DC/OS)</li>
<li>Agent count: 2</li>
<li>Agent virtual machine size: (leave default)</li>
<li>Master count: 1</li>
<li>DNS prefix for container service: myacs</li>
</ul>
<p>Two files are created</p>
<p>The Dockerfile contains: </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">FROM busybox</div><div class="line"></div><div class="line">ENTRYPOINT [&quot;init&quot;]</div></pre></td></tr></table></figure>
<p>The docker-compose.yml file has the following content: </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">version: &apos;2&apos;</div><div class="line">services:</div><div class="line">  node1:</div><div class="line">    build: .</div><div class="line">    container_name: n1</div><div class="line">  node2:</div><div class="line">    build: .</div><div class="line">    container_name: n2</div><div class="line">  node3:</div><div class="line">    build: .</div><div class="line">    container_name: n3</div></pre></td></tr></table></figure>
<h2 id="on-a-single-box"><a href="#on-a-single-box" class="headerlink" title="on a single box"></a>on a single box</h2><p>Here is what I get on the single box: </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line">benjguin@benjguinu1605a:~/simpletest$ docker-compose up -d</div><div class="line">Creating network &quot;simpletest_default&quot; with the default driver</div><div class="line">Creating n1</div><div class="line">Creating n3</div><div class="line">Creating n2</div><div class="line">benjguin@benjguinu1605a:~/simpletest$ docker-compose ps</div><div class="line">Name   Command   State   Ports</div><div class="line">------------------------------</div><div class="line">n1     init      Up</div><div class="line">n2     init      Up</div><div class="line">n3     init      Up</div><div class="line">benjguin@benjguinu1605a:~/simpletest$ docker exec n1 ping -c 2 n2</div><div class="line">PING n2 (172.19.0.4): 56 data bytes</div><div class="line">64 bytes from 172.19.0.4: seq=0 ttl=64 time=0.086 ms</div><div class="line">64 bytes from 172.19.0.4: seq=1 ttl=64 time=0.067 ms</div><div class="line"></div><div class="line">--- n2 ping statistics ---</div><div class="line">2 packets transmitted, 2 packets received, 0% packet loss</div><div class="line">round-trip min/avg/max = 0.067/0.076/0.086 ms</div><div class="line">benjguin@benjguinu1605a:~/simpletest$ docker exec n1 ping -c 2 n3</div><div class="line">PING n3 (172.19.0.3): 56 data bytes</div><div class="line">64 bytes from 172.19.0.3: seq=0 ttl=64 time=0.072 ms</div><div class="line">64 bytes from 172.19.0.3: seq=1 ttl=64 time=0.072 ms</div><div class="line"></div><div class="line">--- n3 ping statistics ---</div><div class="line">2 packets transmitted, 2 packets received, 0% packet loss</div><div class="line">round-trip min/avg/max = 0.072/0.072/0.072 ms</div><div class="line">benjguin@benjguinu1605a:~/simpletest$ docker exec n3 ping -c 2 n1</div><div class="line">PING n1 (172.19.0.2): 56 data bytes</div><div class="line">64 bytes from 172.19.0.2: seq=0 ttl=64 time=0.051 ms</div><div class="line">64 bytes from 172.19.0.2: seq=1 ttl=64 time=0.060 ms</div><div class="line"></div><div class="line">--- n1 ping statistics ---</div><div class="line">2 packets transmitted, 2 packets received, 0% packet loss</div><div class="line">round-trip min/avg/max = 0.051/0.055/0.060 ms</div></pre></td></tr></table></figure>
<h2 id="on-a-Swarm-cluster"><a href="#on-a-Swarm-cluster" class="headerlink" title="on a Swarm cluster"></a>on a Swarm cluster</h2><p>Let’s now do the same from the master node of my ACS cluster.</p>
<p>network information was added to the docker-compose.yml file: </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">version: &apos;2&apos;</div><div class="line">services:</div><div class="line">  node1:</div><div class="line">    build: .</div><div class="line">    container_name: n1</div><div class="line">    networks:</div><div class="line">      - net34</div><div class="line">  node2:</div><div class="line">    build: .</div><div class="line">    container_name: n2</div><div class="line">    networks:</div><div class="line">      - net34</div><div class="line">  node3:</div><div class="line">    build: .</div><div class="line">    container_name: n3</div><div class="line">    networks:</div><div class="line">      - net34</div><div class="line">networks:</div><div class="line">  net34:</div><div class="line">    driver: overlay</div></pre></td></tr></table></figure>
<p>and here is the result of the test:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line">export DOCKER_HOST=172.16.0.5:2375</div><div class="line"></div><div class="line">benjguin@swarm-master-B295EC2C-0:~$ docker-compose up -d</div><div class="line">Creating network &quot;benjguin_net34&quot; with driver &quot;overlay&quot;</div><div class="line">Creating n1</div><div class="line">Creating n3</div><div class="line">Creating n2</div><div class="line">benjguin@swarm-master-B295EC2C-0:~$ docker inspect n1 | grep swarm-agent</div><div class="line">            &quot;Name&quot;: &quot;swarm-agent-B295EC2C000001&quot;,</div><div class="line">benjguin@swarm-master-B295EC2C-0:~$ docker inspect n2 | grep swarm-agent</div><div class="line">            &quot;Name&quot;: &quot;swarm-agent-B295EC2C000000&quot;,</div><div class="line">benjguin@swarm-master-B295EC2C-0:~$ docker inspect n3 | grep swarm-agent</div><div class="line">            &quot;Name&quot;: &quot;swarm-agent-B295EC2C000000&quot;,</div><div class="line"></div><div class="line">benjguin@swarm-master-B295EC2C-0:~$ docker exec n2 ping -c 2 n1</div><div class="line">PING n1 (10.0.0.2): 56 data bytes</div><div class="line">64 bytes from 10.0.0.2: seq=0 ttl=64 time=1.088 ms</div><div class="line">64 bytes from 10.0.0.2: seq=1 ttl=64 time=0.830 ms</div><div class="line"></div><div class="line">--- n1 ping statistics ---</div><div class="line">2 packets transmitted, 2 packets received, 0% packet loss</div><div class="line">round-trip min/avg/max = 0.830/0.959/1.088 ms</div><div class="line">benjguin@swarm-master-B295EC2C-0:~$ docker exec n1 ping -c 2 n2</div><div class="line">PING n2 (10.0.0.4): 56 data bytes</div><div class="line">64 bytes from 10.0.0.4: seq=0 ttl=64 time=0.671 ms</div><div class="line">64 bytes from 10.0.0.4: seq=1 ttl=64 time=0.695 ms</div><div class="line"></div><div class="line">--- n2 ping statistics ---</div><div class="line">2 packets transmitted, 2 packets received, 0% packet loss</div><div class="line">round-trip min/avg/max = 0.671/0.683/0.695 ms</div><div class="line">benjguin@swarm-master-B295EC2C-0:~$ docker exec n1 ping -c 2 n3</div><div class="line">PING n3 (10.0.0.3): 56 data bytes</div><div class="line">64 bytes from 10.0.0.3: seq=0 ttl=64 time=1.050 ms</div><div class="line">64 bytes from 10.0.0.3: seq=1 ttl=64 time=0.783 ms</div><div class="line"></div><div class="line">--- n3 ping statistics ---</div><div class="line">2 packets transmitted, 2 packets received, 0% packet loss</div><div class="line">round-trip min/avg/max = 0.783/0.916/1.050 ms</div><div class="line">benjguin@swarm-master-B295EC2C-0:~$ docker exec n2 ping -c 2 n3</div><div class="line">PING n3 (10.0.0.3): 56 data bytes</div><div class="line">64 bytes from 10.0.0.3: seq=0 ttl=64 time=0.068 ms</div><div class="line">64 bytes from 10.0.0.3: seq=1 ttl=64 time=0.076 ms</div><div class="line"></div><div class="line">--- n3 ping statistics ---</div><div class="line">2 packets transmitted, 2 packets received, 0% packet loss</div><div class="line">round-trip min/avg/max = 0.068/0.072/0.076 ms</div></pre></td></tr></table></figure>
<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>We have containers in a common network which is described only thru docker means.<br>This works on a single host, and also on multiple hosts (in the example, a host had 1 container, another host had 2 of the 3 containers).</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.3-4.fr/2016/08/30/deploying_containers_to_one_or_several_VMs/" data-id="cisij3bgo0000ckcdl940e287" class="article-share-link">Share</a>
      
        <a href="http://blog.3-4.fr/2016/08/30/deploying_containers_to_one_or_several_VMs/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Azure/">Azure</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/docker/">docker</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-2015/12/18/azure_ml_remove_label_from_web_service" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/12/18/azure_ml_remove_label_from_web_service/" class="article-date">
  <time datetime="2015-12-17T23:00:00.000Z" itemprop="datePublished">2015-12-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/12/18/azure_ml_remove_label_from_web_service/">Azure ML, Remove Label From Web Service</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Let’s take the following simple experiment: </p>
<p><img src="/images/151218b/1.png" alt=""></p>
<p>that you publish as a web service</p>
<p><img src="/images/151218b/2.png" alt=""></p>
<p>When you call the web service, you are required to provide the answer to the question you are asking (even if Azure ML won’t use it): </p>
<p><img src="/images/151218b/3.png" alt=""></p>
<p>the solution is quite simple: project columns to remove the label from the input: </p>
<p><img src="/images/151218b/4.png" alt=""></p>
<p>and you’ll get a better question</p>
<p><img src="/images/151218b/5.png" alt=""></p>
<p>:-)<br>Benjamin (@benjguin)</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.3-4.fr/2015/12/18/azure_ml_remove_label_from_web_service/" data-id="cisij5hlw00007wcdzp0a5bs4" class="article-share-link">Share</a>
      
        <a href="http://blog.3-4.fr/2015/12/18/azure_ml_remove_label_from_web_service/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Azure/">Azure</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Azure-Machine-Learning/">Azure Machine Learning</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-2015/12/02/mapr-on-azure" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/12/02/mapr-on-azure/" class="article-date">
  <time datetime="2015-12-01T23:00:00.000Z" itemprop="datePublished">2015-12-02</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/12/02/mapr-on-azure/">MapR on Azure</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p>There are different ways to install Hadoop on Azure. The blog post about the <a href="/2015/12/02a/different-flavors-of-hadoop.html">different flavors of Hadoop</a> will provide more context.</p>
<p>This blog post shows the main steps to start with MapR on Azure. </p>
<h2 id="How-to"><a href="#How-to" class="headerlink" title="How to"></a>How to</h2><p>In order to install the cluster, follow the wizzard that you’ll find in <a href="https://portal.azure.com" target="_blank" rel="external">Azure portal</a>.</p>
<p>Here is a quick view of this wizzard: </p>
<p><img src="/images/151202b/1.png" alt=""></p>
<p><img src="/images/151202b/2.png" alt=""></p>
<p><img src="/images/151202b/3.png" alt=""></p>
<p><img src="/images/151202b/4.png" alt=""></p>
<p><img src="/images/151202b/4b.png" alt=""></p>
<p>Step 3 gives you a chance to download the generated Azure resource manager wizzard that you can modify and deploy as described in the following article: <a href="https://azure.microsoft.com/en-us/documentation/articles/resource-group-template-deploy/" target="_blank" rel="external">Deploy an application with Azure Resource Manager template</a>.</p>
<p><img src="/images/151202b/5.png" alt=""></p>
<p>Once you’ve created the cluster, go to <code>https://{yourclustername}-node0.{install-location}.cloudapp.azure.com:9443</code> and connect.</p>
<p>In my case, I named the cluster <code>mapr34</code> and installed it in North Europe region, so it is <code>https://mapr34-node0.northeurope.cloudapp.azure.com:9443</code>.</p>
<p>NB: this <code>mapr34-node0.northeurope.cloudapp.azure.com</code>host name can be found in the portal when you browse the resource group where the cluster is. It’s attached to the public IP of the node.</p>
<p><img src="/images/151202b/6.png" alt=""></p>
<p>Use mapr as the username and the password you provided in step 2 of the wizzard as the password.</p>
<p><img src="/images/151202b/7.png" alt=""></p>
<p>Select each node and check the disks where you want to install the distributed file system.<br>/dev/sdb1 is the cache disk. The 1023 GB disks are VHDs.</p>
<p>Use the Next button to move on </p>
<p><img src="/images/151202b/8.png" alt=""></p>
<p>Click <code>Install -&gt;</code> to start the installation process.</p>
<p><img src="/images/151202b/9.png" alt=""></p>
<p><img src="/images/151202b/10.png" alt=""></p>
<p>After a number of minutes, the installation completes. </p>
<p><img src="/images/151202b/11.png" alt=""></p>
<p><img src="/images/151202b/12.png" alt=""></p>
<p>On the final step, you can find a link to a short name. Unless you’ve created an SSH tunnel to your cluster, you may need to use the long name instead. In this example where my cluster is called <code>mapr34</code> and is installed in North Europe, the URL is <code>https://mapr34node1:8443/</code>. I replace it by <code>https://mapr34-node1.northeurope.cloudapp.azure.com:8443</code>. </p>
<p>NB: this <code>mapr34-node1.northeurope.cloudapp.azure.com</code>host name can be found in the portal when you browse the resource group where the cluster is. It’s attached to the public IP of the node. </p>
<p><img src="/images/151202b/13.png" alt=""></p>
<p>ypou connect with the same credentials as before: mapr/{the password you provided in step 2 of the creation wizzard}.</p>
<p><img src="/images/151202b/14.png" alt=""></p>
<p>Now that the MapR file system is installed. Let’s see it as HDFS. Let’s also check if we can access Azure blob storage.</p>
<p><img src="/images/151202b/15.png" alt=""></p>
<p>The <code>wasb</code> driver (wasb stands for Windows Azure Storage Blob) is not installed by default :-( .  </p>
<p><img src="/images/151202b/16.png" alt=""></p>
<p><img src="/images/151202b/17.png" alt=""></p>
<p>If you go back to the installation page you’ll have the option to install additional services: </p>
<p><img src="/images/151202b/18.png" alt=""></p>
<p>When you’re done, you can stop the services, before shutting down the Azure virtual machines. If there are many nodes, you may want to use Azure PowerShell module or Azure Command Line Interface (Azure CLI). You can find them in the resources section of <a href="http://azure.com" target="_blank" rel="external">azure.com</a>. </p>
<p><img src="/images/151202b/19.png" alt=""></p>
<p>You may also prefer to remove all the resources that consitute the cluster: VMs, storage, vNet and so on. Of course, all the data will be removed as well, so you are asked to type the resource group before deleting it.</p>
<p><img src="/images/151202b/20.png" alt=""></p>
<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>We saw how to create a MapR cluster in Azure. You just have to enter a few parameters in friendly Web interfaces and wait for the cloud and MapR to create everything for you!</p>
<p>:-)<br>Benjamin (<a href="http://twitter.com/@benjguin" target="_blank" rel="external">@benjguin</a>)</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.3-4.fr/2015/12/02/mapr-on-azure/" data-id="ciqaupb9c0000b0cdvbwlc2sb" class="article-share-link">Share</a>
      
        <a href="http://blog.3-4.fr/2015/12/02/mapr-on-azure/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Azure/">Azure</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Big-Data/">Big Data</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Hadoop/">Hadoop</a></li></ul>

    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/">__('next') &raquo;</a>
  </nav>
</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Azure/">Azure</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Azure-Machine-Learning/">Azure Machine Learning</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/AzureFunctions/">AzureFunctions</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Big-Data/">Big Data</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/BigData/">BigData</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Data-Science/">Data Science</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Hadoop/">Hadoop</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/IoT/">IoT</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Sigfox/">Sigfox</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Spark/">Spark</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/docker/">docker</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/Azure/" style="font-size: 20px;">Azure</a> <a href="/tags/Azure-Machine-Learning/" style="font-size: 10px;">Azure Machine Learning</a> <a href="/tags/AzureFunctions/" style="font-size: 10px;">AzureFunctions</a> <a href="/tags/Big-Data/" style="font-size: 16.67px;">Big Data</a> <a href="/tags/BigData/" style="font-size: 10px;">BigData</a> <a href="/tags/Data-Science/" style="font-size: 13.33px;">Data Science</a> <a href="/tags/Hadoop/" style="font-size: 13.33px;">Hadoop</a> <a href="/tags/IoT/" style="font-size: 13.33px;">IoT</a> <a href="/tags/Sigfox/" style="font-size: 10px;">Sigfox</a> <a href="/tags/Spark/" style="font-size: 10px;">Spark</a> <a href="/tags/docker/" style="font-size: 10px;">docker</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/12/">December 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/09/">September 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/08/">August 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/12/">December 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/11/">November 2015</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2016/12/12/Sample_Flink_Code/">Sample Flink Code That Reads From Kafka and Writes to Cassandra</a>
          </li>
        
          <li>
            <a href="/2016/09/05/IOT_Hub_Azure_Functions_Sigfox/">Tutoriel - Synchronisation De Votre Application De Fonction Avec Le Concentrateur IoT Et Exemple De Connexion Avec Un Objet Sigfox</a>
          </li>
        
          <li>
            <a href="/2016/08/30/deploying_containers_to_one_or_several_VMs/">Deploying Containers to One or Several VMs</a>
          </li>
        
          <li>
            <a href="/2015/12/18/azure_ml_remove_label_from_web_service/">Azure ML, Remove Label From Web Service</a>
          </li>
        
          <li>
            <a href="/2015/12/02/mapr-on-azure/">MapR on Azure</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2016 Benjamin Guinebertière<br>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    
<script>
  var disqus_shortname = 'benjguin-blog34';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/count.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>