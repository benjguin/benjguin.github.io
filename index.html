<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Benjamin Guinebertière&#39;s blog (@benjguin)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="Benjamin Guinebertière's blog (@benjguin)">
<meta property="og:url" content="http://blog.3-4.fr/index.html">
<meta property="og:site_name" content="Benjamin Guinebertière's blog (@benjguin)">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Benjamin Guinebertière's blog (@benjguin)">
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  <script type='text/javascript' src='/js/tag.js'></script>
</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Benjamin Guinebertière&#39;s blog (@benjguin)</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://blog.3-4.fr"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-2016/09/05/IOT_Hub_Azure_Functions_Sigfox" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/09/05/IOT_Hub_Azure_Functions_Sigfox/" class="article-date">
  <time datetime="2016-09-04T22:00:00.000Z" itemprop="datePublished">2016-09-05</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/09/05/IOT_Hub_Azure_Functions_Sigfox/">Tutoriel - Synchronisation De Votre Application De Fonction Avec Le Concentrateur IoT Et Exemple De Connexion Avec Un Objet Sigfox</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Ce tutoriel a été rédigé par Eugénie Vinet, stagiaire à la Direction Technique de Microsoft France de avril à août 2016 avec l’aide de son maître de stage Philippe Beraud, Chief Security Advisor à la Direction Technique.<br>Je remercie Eugénie et Philippe pour cette contribution.</p>
<h2 id="Synchroniser-une-application-de-fonction-avec-un-concentrateur-IoT"><a href="#Synchroniser-une-application-de-fonction-avec-un-concentrateur-IoT" class="headerlink" title="Synchroniser une application de fonction avec un concentrateur IoT"></a>Synchroniser une application de fonction avec un concentrateur IoT</h2><p>Pour créer une application de fonction avec Azure Function App, procédez comme suit :</p>
<p>1/    Connectez-vous au portail d’Azure à l’adresse <a href="https://portal.azure.com" target="_blank" rel="external">https://portal.azure.com</a>  </p>
<p>2/    Cliquez sur <strong>New</strong> en haut à gauche et cherchez Function App. </p>
<p><img src="/images/160905a/img1.png" alt=""></p>
<p>3/     Cliquez sur <strong>create</strong>. Entrez ensuite un nom, lié le à un de vos groupes de ressources existants (ou à défaut créez-en un nouveau). Si vous voulez que votre application de fonction fonctionne en continu, choisissez un plan de service B1 associé au minimum.<br>Le portail <strong>Function App</strong> s’affiche</p>
<p><img src="/images/160905a/img2.png" alt=""></p>
<p>4/    Cliquez sur <strong>Or create your own custom function en bas. </strong>Une liste des modèles disponibles s’affiche pour votre application de fonction.<br><img src="/images/160905a/img3.png" alt=""></p>
<p>5/    Selon votre choix de programmation (C# ou Node) cliquez sur <strong>EventHubTrigger – C#</strong> ou <strong>EventHubTrigger – Node</strong>.<br>Azure Function App propose de déclencher une fonction à partir d’un événement dans un concentrateur d’événements, mais pas dans un concentrateur IOT; cependant, un concentrateur IOT peut être vu comme un concentrateur d’événements. C’est ce que nous allons faire. </p>
<p>6/    Précisez le nom de votre application de fonction et configurez la connexion avec votre concentrateur IoT dans <strong>Event Hub connection</strong>.<br><img src="/images/160905a/img4.png" alt=""></p>
<p>Pour connaître le nom et la chaîne de connexion du concentrateur IoT :</p>
<p>a.    Rendez-vous dans les paramètres de votre concentrateur IoT puis cliquez sur <strong>Messaging</strong>. </p>
<p>b.    Notez la valeur de <strong>Event-Hub compatible name</strong> (par exemple DecodeSigfoxHub dans notre illustration) ainsi que celle de Compatible endpoint.<br><img src="/images/160905a/img5.png" alt=""></p>
<p>c.    Toujours au niveau de votre concentrateur IoT, allez ensuite dans <strong>Shared Access Policies</strong> et copier la <strong>connection string – primary Key</strong>. Enlevez la partie HostName à la chaine de caractères de manière à ne garder que SharedAccessKeyName et SharedAccessKey.  Vous obtenez par exemple :<br><code>SharedAccessKeyName=iothubowner;SharedAccessKey=MrsSPDzU5=8g2gZZPKXOJ9EJ5RDlo2PVzmPuGniLRwQ=</code></p>
<p>d.    Retournez dans la fenêtre de votre application de fonction - ne fermez pas la fenêtre de paramètres de votre concentrateur IoT, vous en aurez besoin plus tard -. Nommez votre application de fonction comme bon vous semble :)</p>
<p>e.    Dans <strong>Event Hub Name</strong>, entrez la valeur précédente de Event-Hub compatible name. Attention cependant, il ne supporte que les noms en minuscule. S’il y a des majuscules dans votre valeur de Event hub compatible name, passez tout en minuscule (par exemple decodesigfoxhub dans notre illustration)  </p>
<p>f.    Cliquez ensuite sur <strong>select</strong> à côté de Event Hub connection. Cliquez ensuite sur<strong> Add a connection</strong> string en haut à droite.<br><img src="/images/160905a/img6.png" alt=""></p>
<p>g.    Dans <strong>Connection name</strong>, spécifiez le nom que vous souhaitez. </p>
<p>h.    Dans <strong>Connection string</strong>, précisez :<br><code>Endpoint=&lt;CompatibleEndpoint&gt;&lt;SharedAccessKeyName&gt;&lt;SharedAccessKey&gt;</code><br>Vous obtenez une chaine de caractère semblable à :<br><code>Endpoint=sb://iothub-ns-decodesigf-499548662a53f6c.servicebus.windows.net/;SharedAccessKeyName=iothubowner;SharedAccessKey=MrsSPDzU5=8g2gZZPKXOJ9EJ5RDlo2PVzmPuGniLRwQ=</code></p>
<p>7/    Validez.<br>Votre application de fonction s’exécutera alors à chaque message reçu par l’utilisateur.<br>Vous pouvez alors modifier les informations que vous recevez de votre concentrateur IoT pour les renvoyer autre part ou les stocker par exemple.<br>Vous trouverez ci-après un exemple concret d’usage d’une application de fonction dans notre contexte, à savoir le décodage de trames Sigfox pour les renvoyer sur la solution préconfigurée de surveillance à distance (Cf. portail associé à l’adresse <a href="https://www.azureiotsuite.com/" target="_blank" rel="external">https://www.azureiotsuite.com/</a>) . </p>
<h2 id="Exemple-avec-IoT-Suie-Objet-Sigfox"><a href="#Exemple-avec-IoT-Suie-Objet-Sigfox" class="headerlink" title="Exemple avec IoT Suie - Objet Sigfox"></a>Exemple avec IoT Suie - Objet Sigfox</h2><p>Nous vous proposons dans cette section un exemple de projet utilisant Azure Function App avec un concentrateur IoT.<br>La solution préconfigurée de surveillance à distance s’attend recevoir des messages sur son concentrateur IoT de type :<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">	DeviceId = XX,</div><div class="line">	Humidity = XX,</div><div class="line">	Temperature = XX,</div><div class="line">	ExternalTemperature = XX</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>Dans ce projet nous voulons utiliser des objets Sigfox (voir ici <a href="http://makers.sigfox.com/#about" target="_blank" rel="external">http://makers.sigfox.com/#about</a>) qui envoient des trames de type :<br>« 422D17 » avec 42 l’identifiant du type d’objet, 2D l’humidité (45%) et 17 la température (en décimal = 23°C). »<br>On va supposer que l’humidité et la température sont deux entiers qui vont de 0 à 100. </p>
<h3 id="Prerequis"><a href="#Prerequis" class="headerlink" title="Prérequis"></a>Prérequis</h3><p>Les prérequis sont les suivants :<br>•    Avoir lié un device Sigfox qui envoie des données de température et d’humidité, Cf. tutoriel <a href="http://danvy.tv/push-your-sigfox-devices-data-to-azure-iot-hub/" target="_blank" rel="external">PUSH YOUR SIGFOX DEVICES DATA TO AZURE IOT HUB</a> .</p>
<p>•    Avoir créé et provisionné une solution préconfigurée de type Solution de surveillance à distance sur le site dédié à l’adresse <a href="http://www.azureiotsuite.com/" target="_blank" rel="external">http://www.azureiotsuite.com/</a>.</p>
<p>•    Avoir suivi l’étape précédente de synchronisation d’une Function App avec un <strong>concentrateur IoT en utilisant le concentrateur IoT Hub lié à l’objet Sigfox</strong>. </p>
<p>Si ces prérequis sont satisfaits, les étapes de mise en œuvre sont les suivantes :</p>
<p>•    Etape 1 – Ajout de l’objet préconfiguré.</p>
<p>•    Etape 2 – Remplissage du fichier JSON.</p>
<p>•    Etape 3 – Ajout des paquets.</p>
<p>•    Etape 4 – Contenu de votre application de fonction.</p>
<p>Nous les développons dans l’ordre au travers d’une section dédiée propre.</p>
<h3 id="Etape-1-–-Ajout-de-l’objet-preconfigure"><a href="#Etape-1-–-Ajout-de-l’objet-preconfigure" class="headerlink" title="Etape 1 – Ajout de l’objet préconfiguré"></a>Etape 1 – Ajout de l’objet préconfiguré</h3><p>Pour ajouter un objet, procédez comme suit :</p>
<ol>
<li>Rendez-vous à présent sur l’environnement de démonstration iotmsfrance à l’adresse <a href="https://www.azureiotsuite.com/" target="_blank" rel="external">https://www.azureiotsuite.com/</a>. </li>
<li>Connectez-vous avec votre compte. Comme cela a été indiqué précédemment, vous devez disposer de privilèges d’administration pour pouvoir enregistrer un objet.<br>De plus, réalisez cette étape UNIQUEMENT si l’objet n’apparait pas dans la liste des appareils du concentrateur IoT de l’environnement de démonstration (vous pouvez vérifié via le portail Azure ou via l’application <strong>Device Explorer</strong>). Si votre objet est déjà présent dans la liste, il faudra le supprimer en utilisant le <strong>Device Explorer</strong>.<br>L’application <strong>Device Explorer</strong> est téléchargeable à l’adresse <a href="https://github.com/Azure/azure-iot-sdks/releases" target="_blank" rel="external">https://github.com/Azure/azure-iot-sdks/releases</a>. Le répertoire d’installation par défaut de cette application est :<br>C:\Program Files (x86)\Microsoft\DeviceExplorer</li>
<li>Une fois sur le site, dans la liste des solutions approvisionnées, sélectionnez la <strong>Solution de surveillance à distance</strong>, c.à.d. la solution <votresolution>.azurewebsite.net.</votresolution></li>
<li>Cliquez en bas à gauche sur <strong>Ajouter un appareil</strong> (ou Add a device en anglais).<br><img src="/images/160905a/img7.png" alt=""><br>L’étape 1 d’ajout d’un appareil s’affiche.<br><img src="/images/160905a/img8.png" alt=""></li>
<li>Dans le cadre <strong>Appareil personnalisé</strong>, sélectionnez <strong>Ajouter un nouveau</strong>. L’étape 2 s’affiche.<br><img src="/images/160905a/img9.png" alt=""></li>
<li>Sélectionnez l’option <strong>Me laisser définir mon propre ID d’appareil</strong> et donnez lui le même ID que dans Sigfox /!\ ça ne marchera pas si vous choisissez un id différent.  </li>
<li>Cliquez sur <strong>Vérifier l’ID</strong>. L’ID doit être disponible. </li>
<li>Cliquez enfin sur <strong>Créer</strong>.<br>A ce stade, l’objet n’est pas activé dans la plateforme. Il va falloir modifier les informations relatives à l’objet dans la base NoSQL DocumentDB. Pour cela, connectez-vous au portail d’Azure à l’adresse <a href="https://portal.azure.com" target="_blank" rel="external">https://portal.azure.com</a>  et réalisez l’étape suivante.  </li>
</ol>
<h2 id="Etape-2-–-Remplissage-du-fichier-JSON"><a href="#Etape-2-–-Remplissage-du-fichier-JSON" class="headerlink" title="Etape 2 – Remplissage du fichier JSON"></a>Etape 2 – Remplissage du fichier JSON</h2><p>Pour remplir le fichier JSON d’informations lié à l’objet, procédez comme suit :</p>
<ol>
<li>Rendez-vous dans la rubrique DocumentDB Accounts sur le portail Azure à l’adresse <a href="https://portal.azure.com" target="_blank" rel="external">https://portal.azure.com</a>.  <img src="/images/160905a/img10.png" alt=""></li>
<li>Sélectionner le compte DocumentDB du projet :<br><img src="/images/160905a/img11.png" alt=""></li>
<li>Cliquez ensuite sur votre base de données DevMgmtDb (1). Dans <strong>DevMgmtDB</strong>, cliquez sur <strong>Document Explorer</strong> (2).  <img src="/images/160905a/img12.png" alt=""><br>Vous devriez voir apparaitre une liste comme celle-ci : </li>
</ol>
<pre><code>{
    &quot;DeviceProperties&quot;: {
    &quot;DeviceID&quot;: &quot;{NomDeVotreDevice}&quot;,
    &quot;HubEnabledState&quot;: true,
    &quot;CreatedTime&quot;: &quot;0001-01-01T00:00:00&quot;,
    &quot;DeviceState&quot;: &quot;normal&quot;,
    &quot;Manufacturer&quot;: &quot;{Manufacturer}&quot;,
    &quot;ModelNumber&quot;: &quot;{NomDuModelDuDevice}&quot;,
    &quot;SerialNumber&quot;: &quot;{NumeroDeSérie}&quot;,
    &quot;FirmwareVersion&quot;: &quot;{FirmwareVersion}&quot;,
    &quot;Platform&quot;: &quot;{Plateform}&quot;,
    &quot;Latitude&quot;: {Longitude} ,
    &quot;Longitude&quot;: {Latitude},
    &quot;Processor&quot;: &quot;{processor}&quot;,
    &quot;InstalledRAM&quot;: &quot;{installedRam}&quot;,
},
&quot;SystemProperties&quot;: {
    &quot;ICCID&quot;: null
},
 &quot;Commands&quot;: [
    {
      &quot;Name&quot;: &quot;PingDevice&quot;,
      &quot;Parameters&quot;: null
    },
    {
      &quot;Name&quot;: &quot;StartTelemetry&quot;,
      &quot;Parameters&quot;: null
    },
{
  &quot;Name&quot;: &quot;StopTelemetry&quot;,
  &quot;Parameters&quot;: null
},
{
  &quot;Name&quot;: &quot;ChangeSetPointTemp&quot;,
  &quot;Parameters&quot;: [
    {
      &quot;Name&quot;: &quot;SetPointTemp&quot;,
      &quot;Type&quot;: &quot;double&quot;
    }
  ]
},
{
  &quot;Name&quot;: &quot;DiagnosticTelemetry&quot;,
  &quot;Parameters&quot;: [
    {
      &quot;Name&quot;: &quot;Active&quot;,
      &quot;Type&quot;: &quot;boolean&quot;
    }
  ]
},
{
  &quot;Name&quot;: &quot;ChangeDeviceState&quot;,
  &quot;Parameters&quot;: [
    {
      &quot;Name&quot;: &quot;DeviceState&quot;,
      &quot;Type&quot;: &quot;string&quot;
    }
  ]
}
],
&quot;CommandHistory&quot;: [],
&quot;IsSimulatedDevice&quot;: 0,
 &quot;id&quot;: &quot;&quot;,
 &quot;Telemetry&quot;: [
    {
  &quot;Name&quot;: &quot;Temperature&quot;,
  &quot;DisplayName&quot;: &quot;Temperature&quot;,
  &quot;Type&quot;: &quot;double&quot;
},
{
  &quot;Name&quot;: &quot;Humidity&quot;,
  &quot;DisplayName&quot;: &quot;Humidity&quot;,
  &quot;Type&quot;: &quot;double&quot;
}
],
 &quot;Version&quot;: &quot;1.0&quot;,
 &quot;ObjectType&quot;: &quot;DeviceInfo&quot;
 }
}
</code></pre><p>Si vous n’avez pas réalisé l’étape 3 si l’objet existait déjà dans le concentrateur IoT, il est possible qu’il n’y ait aucun fichier relatif à l’objet dans la base de données. Il va alors falloir en créer un en cliquant en haut à gauche.<br>Par contre si vous aviez réalisé l’étape 3, le fichier relatif au device devrait se trouver dans la liste. Il devrait avoir un nom de type « 2f23278e-0e82-4850-86f5-b5c3f83a8850 » ou bien le nom du device comme « BFFBA ».  Pour vérifier si un fichier est lié à votre objet, il suffit de l’ouvrir et de lire le DeviceID. Il doit être identique à l’ID que vous avez enregistré sur la page web de la solution de surveillance à distance et identique à l’ID de l’objet enregistré sur le portail Sigfox. (1)<br>Supprimez ou modifiez le contenu du fichier dont le DeviceID est le nom de votre objet et recopier le texte à droite puis complétez/modifiez les zones en jaune comme suit :</p>
<pre><code>    HubEnabledState : doit être passé à true.
    DeviceState : doit être normal. 
    CreatedTime : doit être de la forme : AAAA-MM-JJThh:mm:ss 
Avec AAAA l’année, MM le mois, JJ le jour, hh l’heure, mm les minutes et ss les secondes. 
Il est recommandé de mettre la date et l’heure qu’il est au moment où vous remplissez le fichier mais cela ne va pas avoir d’impact sur le fonctionnement général de la surveillance à distance. 
    SerialNumber : doit préciser le numéro de série de l’objet si celui en est « équipé ». A défaut, écrivez le nom de l’objet entre guillemets.
    Manufacturer : doit préciser le nom du fabricant de l’objet entre guillemets.
    ModelNumber : doit préciser le numéro de modèle de l’objet si celui en est « équipé ». A défaut, écrivez le nom de l’objet entre guillemets
    FirmwareVersion, Platform, Processor et InstalledRam : si vous ne les connaissez pas pour le device utilisé vous pouvez écrire « None ». 
    Latitude et Longitude : vous avez le choix de son emplacement. L’objet s’affichera à l’endroit indiqué sur la carte. Vous pouvez vous aider de ce site : http://www.latlong.net/ pour trouver la longitude et la latitude d’un endroit précis. Attention : la longitude et la latitude ne doivent pas être écrites entre guillemets sur le document. 
    Id : sera l’ID du document que vous avez créé/modifié. Il est recommandé d’utiliser le nom de l’objet afin de retrouver plus facilement le document. 
</code></pre><h2 id="Etape-3-Ajout-des-paquets"><a href="#Etape-3-Ajout-des-paquets" class="headerlink" title="Etape 3 - Ajout des paquets"></a>Etape 3 - Ajout des paquets</h2><p>Tout d’abord nous allons ajouter les paquets nécessaires à notre application de fonction. Pour ceci, nous allons suivre les étapes pour charger un fichier project.json contenant le nom de tous nos paquets (rubrique Package Management sur le site <a href="https://azure.microsoft.com/en-us/documentation/articles/functions-reference-csharp/" target="_blank" rel="external">https://azure.microsoft.com/en-us/documentation/articles/functions-reference-csharp/</a> et File Update ici <a href="https://azure.microsoft.com/en-us/documentation/articles/functions-reference/#fileupdate" target="_blank" rel="external">https://azure.microsoft.com/en-us/documentation/articles/functions-reference/#fileupdate</a> ).<br>Procédez comme suit :</p>
<ol>
<li>Rendez-vous dans les outils de votre application de fonction.<br><img src="/images/160905a/img13.png" alt=""></li>
<li>Cliquez sur Kudu puis sur accédez. Vous vous retrouvez donc sur le système de gestion des fichiers de votre application de fonction. </li>
<li>Allez dans Debug Console puis PowerShell. En utilisant la commande ou bien en utilisant l’explorateur de fichier au-dessus rendez-vous sur D:\home\site\wwwroot\<nomdevotreapplicationdefonction>&gt;</nomdevotreapplicationdefonction></li>
<li><p>Ajoutez alors un fichier project.json qui contient les lignes suivantes - un simple glissé-déposé suffit - :  </p>
<p>  {<br>  “frameworks”: {<br>  “net46”:{</p>
<pre><code>&quot;dependencies&quot;: {                                                
        &quot;Microsoft.Azure.Devices.Client&quot;:&quot;1.0.6&quot;,
        &quot;Newtonsoft.Json&quot;:&quot;8.0.3&quot;,                
        &quot;Microsoft.Azure.Devices&quot;:&quot;1.0.6&quot;            
        }
    }      
}
</code></pre><p>  }</p>
</li>
</ol>
<h2 id="Etape-4-–-Definition-du-contenu-de-votre-application-de-fonction"><a href="#Etape-4-–-Definition-du-contenu-de-votre-application-de-fonction" class="headerlink" title="Etape 4 – Définition du contenu de votre application de fonction"></a>Etape 4 – Définition du contenu de votre application de fonction</h2><p>Pour définir le contenu de votre application de fonction, procédez comme suit :</p>
<p>1/    Retournez sur votre application de fonction et ajoutez la classe <strong>DataToReceive</strong>. Le contenu dépendra du contenu du JSON entré pour le callback de votre Device Type dans le portail Sigfox.<br>Si vous avez par exemple ce JSON : </p>
<pre><code>{
   &quot;device&quot; : &quot;{device}&quot;,
   &quot;data&quot; : &quot;{data}&quot;,
   &quot;time&quot; : {time},
   &quot;snr&quot; : {snr},
   &quot;station&quot; : &quot;{station}&quot;,
   &quot;rssi&quot; : {rssi},
   &quot;seqNumber&quot; : {seqNumber}
}
</code></pre><p>Votre classe <strong>DataToReceive</strong> doit ressembler à cela : </p>
<pre><code>public class DataToReceive
{
    public string device { get; set; }
    public string data { get; set; }
    public double time { get; set; }
    public string seqNumber { get; set; }
    public string rssi { get; set; }
    public string snr { get; set; }
    public string station { get; set; }
}
</code></pre><p>Il faut qu’il y ait au minimum les variables « device » et « data ». </p>
<p>2/    Créer ensuite une classe <strong>DataToSend</strong> qui réunira les informations que vous voulez envoyer dans votre solution préconfigurée de surveillance à distance. Nous envoyons ici que l’Id de l’objet, la température et l’humidité. Vous pouvez ajouter le paramètre <strong>External Température</strong>. </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">public class DataToSend</div><div class="line">&#123;</div><div class="line">    public string DeviceId &#123; get; set; &#125;</div><div class="line">    public double Humidity &#123; get; set; &#125;</div><div class="line">    public double Temperature &#123; get; set; &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>3/    Créez la classe <strong>SendToIotHub</strong> comme suit. Remplacez bien les valeurs de <strong>connectionString</strong> et d’<strong>iotHubUri</strong> par les éléments relatifs au concentrateur IoT de la solution préconfigurée.  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line">public class SendToIotHub</div><div class="line">&#123;</div><div class="line">    DeviceClient deviceClient;</div><div class="line">    Device device;</div><div class="line">    string jsonMessageToSend;</div><div class="line">    string connectionString = &quot;&#123;IotHubConnexionString&#125;&quot;;</div><div class="line">    string iotHubUri = &quot;&#123;IotHubName&#125;.azure-devices.net&quot;;</div><div class="line"></div><div class="line">    public async void sendData(DataToSend data, TraceWriter log)</div><div class="line">    &#123;</div><div class="line">        RegistryManager registryManager = RegistryManager.CreateFromConnectionString(connectionString);</div><div class="line">        device = new Device(data.DeviceId);</div><div class="line">        device = await AddDeviceAsync1(data.DeviceId, registryManager);</div><div class="line">        deviceClient = DeviceClient.Create(iotHubUri, new DeviceAuthenticationWithRegistrySymmetricKey(data.DeviceId,device.Authentication.SymmetricKey.PrimaryKey.ToString()));</div><div class="line">       jsonMessageToSend = JsonConvert.SerializeObject(data);</div><div class="line">        var messageToSend = new Microsoft.Azure.Devices.Client.Message(System.Text.Encoding.ASCII.GetBytes(jsonMessageToSend));</div><div class="line"></div><div class="line">        deviceClient.SendEventAsync(messageToSend);</div><div class="line">        log.Info($&quot;C# Event Hub trigger function processed a message: &#123;jsonMessageToSend&#125;&quot;);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">        private async Task&lt;Device&gt; AddDeviceAsync1(string deviceId, RegistryManager registryManager)</div><div class="line">        &#123;</div><div class="line">            Device device;</div><div class="line">            try</div><div class="line">            &#123;</div><div class="line">                device = await registryManager.AddDeviceAsync(new Device(deviceId));</div><div class="line">    </div><div class="line">            &#125;</div><div class="line">            catch (DeviceAlreadyExistsException)</div><div class="line">            &#123;</div><div class="line">                device = await registryManager.GetDeviceAsync(deviceId);</div><div class="line">            &#125;</div><div class="line">            return device;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>4/    Ajoutez les directives using « de circonstance » au début de votre application de fonction :</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">using Microsoft.Azure.Devices;</div><div class="line">using Microsoft.Azure.Devices.Client;</div><div class="line">using System;</div><div class="line">using Microsoft.Azure.Devices.Common.Exceptions;</div><div class="line">using Newtonsoft.Json;</div></pre></td></tr></table></figure>
<p>5/    Complétez maintenant la méthode <strong>Run</strong> : </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">public static void Run(string myEventHubMessage, TraceWriter log)</div><div class="line">&#123;</div><div class="line">    log.Info($&quot;C# Event Hub trigger function processed a message: &#123;myEventHubMessage&#125;&quot;);</div><div class="line"></div><div class="line">    DataToReceive receivedData = new DataToReceive();</div><div class="line">    DataToSend sentData = new DataToSend();</div><div class="line">    SendToIotHub sendDataToIotHub = new SendToIotHub();</div><div class="line">    receivedData = JsonConvert.DeserializeObject&lt;DataToReceive&gt;(myEventHubMessage);</div><div class="line"></div><div class="line">    if (receivedData.data != null &amp;&amp; receivedData.data.Substring(0, 2) == &quot;42&quot;)</div><div class="line">    &#123;</div><div class="line">            string data = receivedData.data;</div><div class="line">            sentData.Humidity = Convert.ToInt32(data.Substring(2, 2), 16);</div><div class="line">            sentData.Temperature = Convert.ToInt32(data.Substring(4, 2), 16);</div><div class="line">            sentData.DeviceId = receivedData.device;</div><div class="line">            sendDataToIotHub.sendData(sentData, log);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Vous obtiendrez quelque chose de similaire à la capture qui suit si tout va bien :</p>
<p><img src="/images/160905a/img14.png" alt=""></p>
<p>Vous devriez voir dans les logs les messages reçus et envoyés si vous gardez les lignes de code <code>log.info (…..)</code>. </p>
<p>Bien sûr, nous partons du principe que les trames à utiliser sont de la forme <strong>« 422D17 »</strong> (comme développé précédemment) mais il est possible que vous ayez à faire des calculs sur chaque élément de votre trame pour obtenir les valeurs décimales renvoyées par vos capteurs. Pour ceci, renseignez-vous auprès du constructeur de l’objet.  </p>
<p>Et voilà !<br>Ceci conclut ce tutoriel.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.3-4.fr/2016/09/05/IOT_Hub_Azure_Functions_Sigfox/" data-id="cispuveyn0000nscdr86d7mej" class="article-share-link">Share</a>
      
        <a href="http://blog.3-4.fr/2016/09/05/IOT_Hub_Azure_Functions_Sigfox/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Azure/">Azure</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/AzureFunctions/">AzureFunctions</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/IoT/">IoT</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Sigfox/">Sigfox</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-2016/08/30/deploying_containers_to_one_or_several_VMs" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/08/30/deploying_containers_to_one_or_several_VMs/" class="article-date">
  <time datetime="2016-08-30T22:00:00.000Z" itemprop="datePublished">2016-08-31</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/08/30/deploying_containers_to_one_or_several_VMs/">Deploying Containers to One or Several VMs</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Here is a sample test to show how Docker Swarm and Docker Compose simplify network management. </p>
<p>We’ll deploy a topology of 3 containers and see how they can reach each other. In the first case, we deploy it on a single node. In the second case, we deploy it on a 2 host swarm cluster.</p>
<p>The Swarm cluster is created as a Swarm Azure Container Service instance with the main following parameters: </p>
<ul>
<li>Orchestrator configuration: Swarm (btw, other option for ACS is DC/OS)</li>
<li>Agent count: 2</li>
<li>Agent virtual machine size: (leave default)</li>
<li>Master count: 1</li>
<li>DNS prefix for container service: myacs</li>
</ul>
<p>Two files are created</p>
<p>The Dockerfile contains: </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">FROM busybox</div><div class="line"></div><div class="line">ENTRYPOINT [&quot;init&quot;]</div></pre></td></tr></table></figure>
<p>The docker-compose.yml file has the following content: </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">version: &apos;2&apos;</div><div class="line">services:</div><div class="line">  node1:</div><div class="line">    build: .</div><div class="line">    container_name: n1</div><div class="line">  node2:</div><div class="line">    build: .</div><div class="line">    container_name: n2</div><div class="line">  node3:</div><div class="line">    build: .</div><div class="line">    container_name: n3</div></pre></td></tr></table></figure>
<h2 id="on-a-single-box"><a href="#on-a-single-box" class="headerlink" title="on a single box"></a>on a single box</h2><p>Here is what I get on the single box: </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line">benjguin@benjguinu1605a:~/simpletest$ docker-compose up -d</div><div class="line">Creating network &quot;simpletest_default&quot; with the default driver</div><div class="line">Creating n1</div><div class="line">Creating n3</div><div class="line">Creating n2</div><div class="line">benjguin@benjguinu1605a:~/simpletest$ docker-compose ps</div><div class="line">Name   Command   State   Ports</div><div class="line">------------------------------</div><div class="line">n1     init      Up</div><div class="line">n2     init      Up</div><div class="line">n3     init      Up</div><div class="line">benjguin@benjguinu1605a:~/simpletest$ docker exec n1 ping -c 2 n2</div><div class="line">PING n2 (172.19.0.4): 56 data bytes</div><div class="line">64 bytes from 172.19.0.4: seq=0 ttl=64 time=0.086 ms</div><div class="line">64 bytes from 172.19.0.4: seq=1 ttl=64 time=0.067 ms</div><div class="line"></div><div class="line">--- n2 ping statistics ---</div><div class="line">2 packets transmitted, 2 packets received, 0% packet loss</div><div class="line">round-trip min/avg/max = 0.067/0.076/0.086 ms</div><div class="line">benjguin@benjguinu1605a:~/simpletest$ docker exec n1 ping -c 2 n3</div><div class="line">PING n3 (172.19.0.3): 56 data bytes</div><div class="line">64 bytes from 172.19.0.3: seq=0 ttl=64 time=0.072 ms</div><div class="line">64 bytes from 172.19.0.3: seq=1 ttl=64 time=0.072 ms</div><div class="line"></div><div class="line">--- n3 ping statistics ---</div><div class="line">2 packets transmitted, 2 packets received, 0% packet loss</div><div class="line">round-trip min/avg/max = 0.072/0.072/0.072 ms</div><div class="line">benjguin@benjguinu1605a:~/simpletest$ docker exec n3 ping -c 2 n1</div><div class="line">PING n1 (172.19.0.2): 56 data bytes</div><div class="line">64 bytes from 172.19.0.2: seq=0 ttl=64 time=0.051 ms</div><div class="line">64 bytes from 172.19.0.2: seq=1 ttl=64 time=0.060 ms</div><div class="line"></div><div class="line">--- n1 ping statistics ---</div><div class="line">2 packets transmitted, 2 packets received, 0% packet loss</div><div class="line">round-trip min/avg/max = 0.051/0.055/0.060 ms</div></pre></td></tr></table></figure>
<h2 id="on-a-Swarm-cluster"><a href="#on-a-Swarm-cluster" class="headerlink" title="on a Swarm cluster"></a>on a Swarm cluster</h2><p>Let’s now do the same from the master node of my ACS cluster.</p>
<p>network information was added to the docker-compose.yml file: </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">version: &apos;2&apos;</div><div class="line">services:</div><div class="line">  node1:</div><div class="line">    build: .</div><div class="line">    container_name: n1</div><div class="line">    networks:</div><div class="line">      - net34</div><div class="line">  node2:</div><div class="line">    build: .</div><div class="line">    container_name: n2</div><div class="line">    networks:</div><div class="line">      - net34</div><div class="line">  node3:</div><div class="line">    build: .</div><div class="line">    container_name: n3</div><div class="line">    networks:</div><div class="line">      - net34</div><div class="line">networks:</div><div class="line">  net34:</div><div class="line">    driver: overlay</div></pre></td></tr></table></figure>
<p>and here is the result of the test:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line">export DOCKER_HOST=172.16.0.5:2375</div><div class="line"></div><div class="line">benjguin@swarm-master-B295EC2C-0:~$ docker-compose up -d</div><div class="line">Creating network &quot;benjguin_net34&quot; with driver &quot;overlay&quot;</div><div class="line">Creating n1</div><div class="line">Creating n3</div><div class="line">Creating n2</div><div class="line">benjguin@swarm-master-B295EC2C-0:~$ docker inspect n1 | grep swarm-agent</div><div class="line">            &quot;Name&quot;: &quot;swarm-agent-B295EC2C000001&quot;,</div><div class="line">benjguin@swarm-master-B295EC2C-0:~$ docker inspect n2 | grep swarm-agent</div><div class="line">            &quot;Name&quot;: &quot;swarm-agent-B295EC2C000000&quot;,</div><div class="line">benjguin@swarm-master-B295EC2C-0:~$ docker inspect n3 | grep swarm-agent</div><div class="line">            &quot;Name&quot;: &quot;swarm-agent-B295EC2C000000&quot;,</div><div class="line"></div><div class="line">benjguin@swarm-master-B295EC2C-0:~$ docker exec n2 ping -c 2 n1</div><div class="line">PING n1 (10.0.0.2): 56 data bytes</div><div class="line">64 bytes from 10.0.0.2: seq=0 ttl=64 time=1.088 ms</div><div class="line">64 bytes from 10.0.0.2: seq=1 ttl=64 time=0.830 ms</div><div class="line"></div><div class="line">--- n1 ping statistics ---</div><div class="line">2 packets transmitted, 2 packets received, 0% packet loss</div><div class="line">round-trip min/avg/max = 0.830/0.959/1.088 ms</div><div class="line">benjguin@swarm-master-B295EC2C-0:~$ docker exec n1 ping -c 2 n2</div><div class="line">PING n2 (10.0.0.4): 56 data bytes</div><div class="line">64 bytes from 10.0.0.4: seq=0 ttl=64 time=0.671 ms</div><div class="line">64 bytes from 10.0.0.4: seq=1 ttl=64 time=0.695 ms</div><div class="line"></div><div class="line">--- n2 ping statistics ---</div><div class="line">2 packets transmitted, 2 packets received, 0% packet loss</div><div class="line">round-trip min/avg/max = 0.671/0.683/0.695 ms</div><div class="line">benjguin@swarm-master-B295EC2C-0:~$ docker exec n1 ping -c 2 n3</div><div class="line">PING n3 (10.0.0.3): 56 data bytes</div><div class="line">64 bytes from 10.0.0.3: seq=0 ttl=64 time=1.050 ms</div><div class="line">64 bytes from 10.0.0.3: seq=1 ttl=64 time=0.783 ms</div><div class="line"></div><div class="line">--- n3 ping statistics ---</div><div class="line">2 packets transmitted, 2 packets received, 0% packet loss</div><div class="line">round-trip min/avg/max = 0.783/0.916/1.050 ms</div><div class="line">benjguin@swarm-master-B295EC2C-0:~$ docker exec n2 ping -c 2 n3</div><div class="line">PING n3 (10.0.0.3): 56 data bytes</div><div class="line">64 bytes from 10.0.0.3: seq=0 ttl=64 time=0.068 ms</div><div class="line">64 bytes from 10.0.0.3: seq=1 ttl=64 time=0.076 ms</div><div class="line"></div><div class="line">--- n3 ping statistics ---</div><div class="line">2 packets transmitted, 2 packets received, 0% packet loss</div><div class="line">round-trip min/avg/max = 0.068/0.072/0.076 ms</div></pre></td></tr></table></figure>
<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>We have containers in a common network which is described only thru docker means.<br>This works on a single host, and also on multiple hosts (in the example, a host had 1 container, another host had 2 of the 3 containers).</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.3-4.fr/2016/08/30/deploying_containers_to_one_or_several_VMs/" data-id="cisij3bgo0000ckcdl940e287" class="article-share-link">Share</a>
      
        <a href="http://blog.3-4.fr/2016/08/30/deploying_containers_to_one_or_several_VMs/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Azure/">Azure</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/docker/">docker</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-2015/12/18/azure_ml_remove_label_from_web_service" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/12/18/azure_ml_remove_label_from_web_service/" class="article-date">
  <time datetime="2015-12-17T23:00:00.000Z" itemprop="datePublished">2015-12-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/12/18/azure_ml_remove_label_from_web_service/">Azure ML, Remove Label From Web Service</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Let’s take the following simple experiment: </p>
<p><img src="/images/151218b/1.png" alt=""></p>
<p>that you publish as a web service</p>
<p><img src="/images/151218b/2.png" alt=""></p>
<p>When you call the web service, you are required to provide the answer to the question you are asking (even if Azure ML won’t use it): </p>
<p><img src="/images/151218b/3.png" alt=""></p>
<p>the solution is quite simple: project columns to remove the label from the input: </p>
<p><img src="/images/151218b/4.png" alt=""></p>
<p>and you’ll get a better question</p>
<p><img src="/images/151218b/5.png" alt=""></p>
<p>:-)<br>Benjamin (@benjguin)</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.3-4.fr/2015/12/18/azure_ml_remove_label_from_web_service/" data-id="cisij5hlw00007wcdzp0a5bs4" class="article-share-link">Share</a>
      
        <a href="http://blog.3-4.fr/2015/12/18/azure_ml_remove_label_from_web_service/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Azure/">Azure</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Azure-Machine-Learning/">Azure Machine Learning</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-2015/12/02/mapr-on-azure" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/12/02/mapr-on-azure/" class="article-date">
  <time datetime="2015-12-01T23:00:00.000Z" itemprop="datePublished">2015-12-02</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/12/02/mapr-on-azure/">MapR on Azure</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p>There are different ways to install Hadoop on Azure. The blog post about the <a href="/2015/12/02a/different-flavors-of-hadoop.html">different flavors of Hadoop</a> will provide more context.</p>
<p>This blog post shows the main steps to start with MapR on Azure. </p>
<h2 id="How-to"><a href="#How-to" class="headerlink" title="How to"></a>How to</h2><p>In order to install the cluster, follow the wizzard that you’ll find in <a href="https://portal.azure.com" target="_blank" rel="external">Azure portal</a>.</p>
<p>Here is a quick view of this wizzard: </p>
<p><img src="/images/151202b/1.png" alt=""></p>
<p><img src="/images/151202b/2.png" alt=""></p>
<p><img src="/images/151202b/3.png" alt=""></p>
<p><img src="/images/151202b/4.png" alt=""></p>
<p><img src="/images/151202b/4b.png" alt=""></p>
<p>Step 3 gives you a chance to download the generated Azure resource manager wizzard that you can modify and deploy as described in the following article: <a href="https://azure.microsoft.com/en-us/documentation/articles/resource-group-template-deploy/" target="_blank" rel="external">Deploy an application with Azure Resource Manager template</a>.</p>
<p><img src="/images/151202b/5.png" alt=""></p>
<p>Once you’ve created the cluster, go to <code>https://{yourclustername}-node0.{install-location}.cloudapp.azure.com:9443</code> and connect.</p>
<p>In my case, I named the cluster <code>mapr34</code> and installed it in North Europe region, so it is <code>https://mapr34-node0.northeurope.cloudapp.azure.com:9443</code>.</p>
<p>NB: this <code>mapr34-node0.northeurope.cloudapp.azure.com</code>host name can be found in the portal when you browse the resource group where the cluster is. It’s attached to the public IP of the node.</p>
<p><img src="/images/151202b/6.png" alt=""></p>
<p>Use mapr as the username and the password you provided in step 2 of the wizzard as the password.</p>
<p><img src="/images/151202b/7.png" alt=""></p>
<p>Select each node and check the disks where you want to install the distributed file system.<br>/dev/sdb1 is the cache disk. The 1023 GB disks are VHDs.</p>
<p>Use the Next button to move on </p>
<p><img src="/images/151202b/8.png" alt=""></p>
<p>Click <code>Install -&gt;</code> to start the installation process.</p>
<p><img src="/images/151202b/9.png" alt=""></p>
<p><img src="/images/151202b/10.png" alt=""></p>
<p>After a number of minutes, the installation completes. </p>
<p><img src="/images/151202b/11.png" alt=""></p>
<p><img src="/images/151202b/12.png" alt=""></p>
<p>On the final step, you can find a link to a short name. Unless you’ve created an SSH tunnel to your cluster, you may need to use the long name instead. In this example where my cluster is called <code>mapr34</code> and is installed in North Europe, the URL is <code>https://mapr34node1:8443/</code>. I replace it by <code>https://mapr34-node1.northeurope.cloudapp.azure.com:8443</code>. </p>
<p>NB: this <code>mapr34-node1.northeurope.cloudapp.azure.com</code>host name can be found in the portal when you browse the resource group where the cluster is. It’s attached to the public IP of the node. </p>
<p><img src="/images/151202b/13.png" alt=""></p>
<p>ypou connect with the same credentials as before: mapr/{the password you provided in step 2 of the creation wizzard}.</p>
<p><img src="/images/151202b/14.png" alt=""></p>
<p>Now that the MapR file system is installed. Let’s see it as HDFS. Let’s also check if we can access Azure blob storage.</p>
<p><img src="/images/151202b/15.png" alt=""></p>
<p>The <code>wasb</code> driver (wasb stands for Windows Azure Storage Blob) is not installed by default :-( .  </p>
<p><img src="/images/151202b/16.png" alt=""></p>
<p><img src="/images/151202b/17.png" alt=""></p>
<p>If you go back to the installation page you’ll have the option to install additional services: </p>
<p><img src="/images/151202b/18.png" alt=""></p>
<p>When you’re done, you can stop the services, before shutting down the Azure virtual machines. If there are many nodes, you may want to use Azure PowerShell module or Azure Command Line Interface (Azure CLI). You can find them in the resources section of <a href="http://azure.com" target="_blank" rel="external">azure.com</a>. </p>
<p><img src="/images/151202b/19.png" alt=""></p>
<p>You may also prefer to remove all the resources that consitute the cluster: VMs, storage, vNet and so on. Of course, all the data will be removed as well, so you are asked to type the resource group before deleting it.</p>
<p><img src="/images/151202b/20.png" alt=""></p>
<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>We saw how to create a MapR cluster in Azure. You just have to enter a few parameters in friendly Web interfaces and wait for the cloud and MapR to create everything for you!</p>
<p>:-)<br>Benjamin (<a href="http://twitter.com/@benjguin" target="_blank" rel="external">@benjguin</a>)</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.3-4.fr/2015/12/02/mapr-on-azure/" data-id="ciqaupb9c0000b0cdvbwlc2sb" class="article-share-link">Share</a>
      
        <a href="http://blog.3-4.fr/2015/12/02/mapr-on-azure/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Azure/">Azure</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Big-Data/">Big Data</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Hadoop/">Hadoop</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-2015/12/02/different-flavors-of-hadoop" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/12/02/different-flavors-of-hadoop/" class="article-date">
  <time datetime="2015-12-01T23:00:00.000Z" itemprop="datePublished">2015-12-02</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/12/02/different-flavors-of-hadoop/">Different Flavors of Hadoop &amp; Spark</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>There are four main ways to install Hadoop &amp; Spark: </p>
<ul>
<li>from Apache (<a href="http://hadoop.apache.org/releases.html" target="_blank" rel="external">http://hadoop.apache.org/releases.html</a>) </li>
<li>from Cloudera’s distribution (<a href="http://www.cloudera.com" target="_blank" rel="external">http://www.cloudera.com</a>)</li>
<li>from HortonWorks’ distribution (<a href="http://hortonworks.com" target="_blank" rel="external">http://hortonworks.com</a>)</li>
<li>from MapR’s distribution (<a href="http://mapr.com" target="_blank" rel="external">http://mapr.com</a>)</li>
</ul>
<p>This blog post shows the different options in the context of Azure.</p>
<h2 id="From-Apache-http-hadoop-apache-org-releases-html"><a href="#From-Apache-http-hadoop-apache-org-releases-html" class="headerlink" title="From Apache (http://hadoop.apache.org/releases.html)"></a>From Apache (<a href="http://hadoop.apache.org/releases.html" target="_blank" rel="external">http://hadoop.apache.org/releases.html</a>)</h2><p>This option is chosen by people who want to select the components themselves, and want to get the releases as soon as they are available.  </p>
<p>If you want that option, it’s probably because your want to have control, rather than using a cluster somebody tailored for you.<br>The recommended way to do in Azure is to use Azure Virtual Machines, virtual network, and install everything yourself.<br>For that, you may want to leverage <a href="https://azure.microsoft.com/en-us/documentation/articles/resource-group-authoring-templates/" target="_blank" rel="external">Azure Resource Manager templates</a>. A number of examples are available on <a href="https://github.com/Azure/azure-quickstart-template" target="_blank" rel="external">GitHub</a>. For instance, <a href="https://github.com/Azure/azure-quickstart-templates/tree/master/zookeeper-cluster-ubuntu-vm" target="_blank" rel="external">this one</a> deploys a Zookeeper cluster on Ubuntu VMs.</p>
<h2 id="Hadoop-architecture-on-Azure"><a href="#Hadoop-architecture-on-Azure" class="headerlink" title="Hadoop architecture on Azure"></a>Hadoop architecture on Azure</h2><p>There are several ways to deploy a Hadoop cluster on Azure, and several ways to store the data.<br>A virtual machine on Azure has </p>
<ul>
<li>local disk which is mainly used for cache (Cache disk), </li>
<li>Virtual Hard Disks (VHD) that live in the Azure storage; in particular, this is the case of the OS disk (the only exception is with web and worker roles)</li>
<li>the virtual machine can also access blob storage which is a storage service where one can put files. It is accessible thru REST API, but also thru the wasb (Windows Azure Storage Blob) driver which is available in Hadoop.</li>
</ul>
<p><img src="/images/151202a/2.png" alt=""></p>
<p>Data Lake Store is also a new way of storing big data. For now (NOV 2015) it is in preview and can be used from Data Lake Analytics and HDInsight; later on, it will also be usable from standard distributions:</p>
<p><img src="/images/151202a/3.png" alt=""></p>
<h3 id="Comparing-Cloudera-Hortonworks-and-MapR"><a href="#Comparing-Cloudera-Hortonworks-and-MapR" class="headerlink" title="Comparing Cloudera, Hortonworks and MapR"></a>Comparing Cloudera, Hortonworks and MapR</h3><p><a href="https://www.bing.com/search?q=hortonworks+and+cloudera+and+mapr" target="_blank" rel="external">Many articles</a> have been written on how the distributions compare.</p>
<p>Here is how I see them.</p>
<p><strong>Hortonworks</strong> is the closest to the Apache Hadoop distribution; All their code is Apache’s code and 100% open source. Hortonworks Data Platform (HDP) is described <a href="http://hortonworks.com/hdp/whats-new/" target="_blank" rel="external">here</a>.</p>
<p><strong>Cloudera</strong> is the mots popular; in particular, users like <a href="http://www.cloudera.com/content/www/en-us/products/apache-hadoop/impala.html" target="_blank" rel="external">Impala</a> and <a href="http://www.cloudera.com/content/www/en-us/products/cloudera-manager.html" target="_blank" rel="external">Cloudera Manager</a>. Their code is 100% open source, but not 100% Apache code (yet?). They recently decided to donate Impala and Kudu to the Apache Software Foundation.</p>
<p><strong>MapR</strong> builds a distribution for business critical production applications; they are well known for their MapR file system (MapR-FS) which can be viewed as HDFS (Hadoop Distributed File System) and NFS (Network File System), and has the reputation of being fast. Mapr-FS is proprietary. The distribution is described <a href="https://www.mapr.com/products/mapr-distribution-including-apache-hadoop" target="_blank" rel="external">here</a>.</p>
<p>Anyway, the best solution is the one you chose!</p>
<p>Here is how those distribution leverage Azure. They have different approaches.</p>
<table>
<thead>
<tr>
<th>Distribution</th>
<th>uses Cache Disk</th>
<th>uses VHD</th>
<th>uses blobs</th>
<th>prices</th>
<th>options</th>
</tr>
</thead>
<tbody>
<tr>
<td>Cloudera</td>
<td>Yes</td>
<td>Yes, premium storage only</td>
<td>for cold archive only</td>
<td>high only because Cloudera supports only high end performances</td>
<td>Cluster, single VM</td>
</tr>
<tr>
<td>Hortonworks</td>
<td>not by default (HDFS)</td>
<td>Yes (HDFS)</td>
<td>Yes</td>
<td>low to high</td>
<td>Cluster, single VM, Hadoop as a service (HDInsight)</td>
</tr>
<tr>
<td>MapR</td>
<td>Yes (Mapr-FS)</td>
<td>Yes (Mapr-FS)</td>
<td>No. wasb driver is not installed</td>
<td>low to high</td>
<td>Cluster</td>
</tr>
</tbody>
</table>
<p>NB: the options mentioned above are automated ones. Of course, you can leverage Azure virtual machines and virtual networks to install any distribution you like on a single VM or on a cluster. </p>
<p>The fact that Cloudera only supports blob storage as a cold archive makes it more difficult to create different clusters on the same storage. It also requires that you save the data to blob storage explicitely before shutting down if you need to access the data while the cluster is off.</p>
<p>With MapR, as you don’t have the wasb driver, it is difficult to make the data available while the cluster is shut down.</p>
<p>With Hortonworks, you can use Azure blob storage as the default distributed file system. With that, you can start the cluster only when you need compute power. The rest of the time, you can bring data to the storage thru REST API, or SDKs in different languages. When you need compute, you can create a cluster that has the required size. You loose collocality (which is mainly important in the first map phase, before shuffle), but you win a lot of flexibility. </p>
<p>I hope that MapR and Cloudera will enhance their usage of cloud storage with Azure Data Lake Store. Azure Data Lake should meet the performance requirements of Cloudera so that they don’t use it only for cold archive. I’m quite confident that Hortonworks will add Azure Data Lake driver. This is already the case with HDInsight. </p>
<p>Let now see how you can deploy those distributions on Azure.</p>
<h3 id="Cloudera-http-www-cloudera-com"><a href="#Cloudera-http-www-cloudera-com" class="headerlink" title="Cloudera (http://www.cloudera.com)"></a>Cloudera (<a href="http://www.cloudera.com" target="_blank" rel="external">http://www.cloudera.com</a>)</h3><p>There are different options. This <a href="http://www.cloudera.com/content/dam/cloudera/Resources/PDF/Datasheet/datasheet-cloudera-enterprise.pdf" target="_blank" rel="external">page</a> from Cloudera’s web site show the different available distributions. From Azure marketplace, you can find the following (as of 2 DEC 2015):</p>
<p><img src="/images/151202a/4.png" alt=""></p>
<p>An automated way of deploying a <strong>Cloudera Enterprise Data Hub cluster</strong> <a href="https://azure.microsoft.com/en-us/marketplace/partners/cloudera/clouderaedhcloudera/" target="_blank" rel="external">has been made available by Cloudera on Azure</a>. </p>
<p><img src="/images/151202a/1.png" alt=""></p>
<p>You’ll find a <a href="https://azure.microsoft.com/en-us/blog/full-cloudera-enterprise-edh-support-on-azure/" target="_blank" rel="external">blog post</a> on how to deploy it on the Azure web site. Also make sure to read the last paragraph (Cloudera Enterprise Deployment from GitHub) which explains there is also a <a href="https://github.com/Azure/azure-quickstart-templates/tree/master/cloudera-on-centos" target="_blank" rel="external">template on GitHub</a> if you need more flexibility.</p>
<p>If you prefer to install <strong>a single VM</strong>, you can use the Cloudera-Centos-6.6 offer. Its documentation is available at <a href="https://azure.microsoft.com/en-us/marketplace/partners/cloudera/cloudera-centos-6/" target="_blank" rel="external">azure.microsoft.com/en-us/marketplace/partners/cloudera/cloudera-centos-6/</a>.</p>
<h3 id="HortonWorks-http-hortonworks-com"><a href="#HortonWorks-http-hortonworks-com" class="headerlink" title="HortonWorks (http://hortonworks.com)"></a>HortonWorks (<a href="http://hortonworks.com" target="_blank" rel="external">http://hortonworks.com</a>)</h3><p>In order to install <strong>Hadoop as a service</strong> with an Hadoop Data Platform, you can leverage HDInsight on Windows or Linux nodes. Documentation is available at <a href="https://azure.microsoft.com/en-us/documentation/services/hdinsight/" target="_blank" rel="external">azure.microsoft.com/en-us/documentation/services/hdinsight/</a>.</p>
<p>Besides HDInsight, the marketplace has other options: </p>
<p><img src="/images/151202a/5.png" alt=""></p>
<p>In order to install an <strong>HDP cluster</strong>, you can leverage the wizzard. Note that as of today (2 DEC 2015), the wizzard deploys HDP 2.1, while latest version of HDP is 2.3. An updated version of this wizzard should be made available in the coming weeks, hopefully. If you want to have an early look at this, I think this is on Github: <a href="https://github.com/Azure/azure-quickstart-templates/tree/master/hortonworks-on-centos" target="_blank" rel="external">github.com/Azure/azure-quickstart-templates/tree/master/hortonworks-on-centos</a>.</p>
<p>If you want to install <strong>a single VM</strong>, a sandbox is available. If you can read French or if you know how to have the page translated for you, you are welcome to read my previous post: <a href="http://blogs.msdn.com/b/benjguin/archive/2015/11/16/hadoop-comment-r-233-duire-ses-co-251-ts-hdinsight-pour-le-d-233-veloppement.aspx" target="_blank" rel="external">Hadoop : Comment réduire ses coûts HDInsight pour le développement</a></p>
<h3 id="MapR-http-mapr-com"><a href="#MapR-http-mapr-com" class="headerlink" title="MapR (http://mapr.com)"></a>MapR (<a href="http://mapr.com" target="_blank" rel="external">http://mapr.com</a>)</h3><p>MapR is also available on the Azure marketplace: </p>
<p><img src="/images/151202a/6.png" alt=""></p>
<p>In order to install the cluster, please see <a href="/2015/12/02b/mapr-on-azure.html">this blog post</a></p>
<h3 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h3><p>We saw that there are a number of options to install Hadoop on Azure. </p>
<p>Want to comment? I’m sorry, I didn’t leverage a tool like Disqus yet on this blog. Please feel free to e-mail me at my twitter alias at microsoft dot com and I’ll include your remarks in the body of this post. </p>
<p>:-)<br>Benjamin (<a href="http://twitter.com/@benjguin" target="_blank" rel="external">@benjguin</a>) </p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.3-4.fr/2015/12/02/different-flavors-of-hadoop/" data-id="ciqaupb9c0003b0cd1jwyxdgu" class="article-share-link">Share</a>
      
        <a href="http://blog.3-4.fr/2015/12/02/different-flavors-of-hadoop/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Azure/">Azure</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Big-Data/">Big Data</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Hadoop/">Hadoop</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Spark/">Spark</a></li></ul>

    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/">__('next') &raquo;</a>
  </nav>
</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Azure/">Azure</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Azure-Machine-Learning/">Azure Machine Learning</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/AzureFunctions/">AzureFunctions</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Big-Data/">Big Data</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Data-Science/">Data Science</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Hadoop/">Hadoop</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/IoT/">IoT</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Sigfox/">Sigfox</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Spark/">Spark</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/docker/">docker</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/Azure/" style="font-size: 20px;">Azure</a> <a href="/tags/Azure-Machine-Learning/" style="font-size: 10px;">Azure Machine Learning</a> <a href="/tags/AzureFunctions/" style="font-size: 10px;">AzureFunctions</a> <a href="/tags/Big-Data/" style="font-size: 16.67px;">Big Data</a> <a href="/tags/Data-Science/" style="font-size: 13.33px;">Data Science</a> <a href="/tags/Hadoop/" style="font-size: 13.33px;">Hadoop</a> <a href="/tags/IoT/" style="font-size: 10px;">IoT</a> <a href="/tags/Sigfox/" style="font-size: 10px;">Sigfox</a> <a href="/tags/Spark/" style="font-size: 10px;">Spark</a> <a href="/tags/docker/" style="font-size: 10px;">docker</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/09/">September 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/08/">August 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/12/">December 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/11/">November 2015</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2016/09/05/IOT_Hub_Azure_Functions_Sigfox/">Tutoriel - Synchronisation De Votre Application De Fonction Avec Le Concentrateur IoT Et Exemple De Connexion Avec Un Objet Sigfox</a>
          </li>
        
          <li>
            <a href="/2016/08/30/deploying_containers_to_one_or_several_VMs/">Deploying Containers to One or Several VMs</a>
          </li>
        
          <li>
            <a href="/2015/12/18/azure_ml_remove_label_from_web_service/">Azure ML, Remove Label From Web Service</a>
          </li>
        
          <li>
            <a href="/2015/12/02/mapr-on-azure/">MapR on Azure</a>
          </li>
        
          <li>
            <a href="/2015/12/02/different-flavors-of-hadoop/">Different Flavors of Hadoop &amp; Spark</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2016 Benjamin Guinebertière<br>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    
<script>
  var disqus_shortname = 'benjguin-blog34';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/count.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>